<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvaluaciÃ³n Modular - Universidad Virtual CNCI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDf2ns9wzXixZHiWO5_kL1OnDr9iYbAaTI",
            authDomain: "instrumentoevaluacioncnci.firebaseapp.com",
            projectId: "instrumentoevaluacioncnci",
            storageBucket: "instrumentoevaluacioncnci.firebasestorage.app",
            messagingSenderId: "979030591942",
            appId: "1:979030591942:web:5efcac6a4675de473a4ac7",
            measurementId: "G-4PDCMV8LC4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        
        // Firebase functions
        window.firebaseFunctions = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where
        };
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #2a6aff 0%, #ff8500 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(42, 106, 255, 0.1);
        }
        .tab-active {
            background: linear-gradient(135deg, #2a6aff, #ff8500);
            color: white;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2a6aff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ”§ Configurando Firebase</h2>
            <p class="text-gray-600">Inicializando base de datos...</p>
            <div id="initProgress" class="mt-4 text-sm text-[#2a6aff]">Conectando...</div>
        </div>
    </div>

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo Universidad Virtual CNCI" class="mx-auto mb-6 h-20 object-contain">
                <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">ğŸ“Š EvaluaciÃ³n Modular</h1>
                <h2 id="loginSubtitle" class="text-lg text-[#2a6aff] font-semibold mb-1">Universidad Virtual CNCI</h2>
                <p id="loginDepartment" class="text-[#ff8500] font-medium mb-4">Departamento de Servicios Estudiantiles</p>
                <p id="loginDescription" class="text-gray-600 text-sm">ğŸ” Consulta tu desempeÃ±o del mÃ³dulo de manera detallada ingresando tu usuario</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ğŸ‘¨â€ğŸ’¼ Administrador</label>
                    <select id="adminSelect" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff] focus:border-transparent transition-all">
                        <option value="">Selecciona tu administrador</option>
                        <option value="Admin01">Admin01 - Departamento AcadÃ©mico</option>
                        <option value="Admin02">Admin02 - Servicios Estudiantiles</option>
                        <option value="Admin03">Admin03 - Admisiones</option>
                        <option value="Admin04">Admin04 - Finanzas</option>
                        <option value="Admin05">Admin05 - TecnologÃ­a</option>
                        <option value="Admin06">Admin06 - Recursos Humanos</option>
                        <option value="Admin07">Admin07 - Marketing</option>
                        <option value="Admin08">Admin08 - Calidad</option>
                        <option value="Admin09">Admin09 - InvestigaciÃ³n y Desarrollo</option>
                        <option value="Admin10">Admin10 - Relaciones Internacionales</option>
                        <option value="Admin11">Admin11 - Bienestar Estudiantil</option>
                        <option value="Admin12">Admin12 - EducaciÃ³n Continua</option>
                        <option value="Admin13">Admin13 - VinculaciÃ³n Empresarial</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ğŸ‘¤ Usuario</label>
                    <input type="text" id="username" required placeholder="Ej: usuario01, Admin01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff] focus:border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ğŸ”’ ContraseÃ±a</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff] focus:border-transparent transition-all">
                </div>
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all transform hover:scale-105">
                    ğŸš€ Consultar mi EvaluaciÃ³n
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                âŒ Error en el inicio de sesiÃ³n. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="adminPanel" class="min-h-screen p-6 hidden">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">
                <!-- Header con botones -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">ğŸ‘¨â€ğŸ’¼ Panel de Administrador</h1>
                        <p class="text-gray-600 mt-1">SesiÃ³n: <span id="currentAdminInfo" class="text-[#2a6aff] font-semibold">Cargando...</span></p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="initFirebaseBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            ğŸ”§ Inicializar Firebase
                        </button>
                        <button id="addAdminBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            ğŸ‘¨â€ğŸ’¼ AÃ±adir Admin
                        </button>
                        <button id="manageAdminsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            âš™ï¸ Gestionar Admins
                        </button>
                        <button id="downloadCSVBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            ğŸ“¥ Descargar CSV
                        </button>
                        <button id="uploadCSVBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            ğŸ“¤ Cargar CSV
                        </button>
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                        <button id="clearTableBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            ğŸ—‘ï¸ Vaciar Tabla
                        </button>
                        <button id="adminLogout" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all text-sm">
                            ğŸšª Cerrar SesiÃ³n
                        </button>
                    </div>
                </div>

                <!-- Estado de Firebase -->
                <div id="firebaseStatus" class="mb-8 p-4 rounded-lg border">
                    <h3 class="font-semibold mb-2">ğŸ”¥ Estado de Firebase</h3>
                    <div id="statusContent" class="text-sm text-gray-600">
                        Verificando conexiÃ³n...
                    </div>
                </div>

                <!-- SecciÃ³n de EdiciÃ³n General -->
                <div class="mb-8 bg-gray-50 rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ EdiciÃ³n General</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">TÃ­tulo Principal</label>
                            <input type="text" id="mainTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="EvaluaciÃ³n Modular â€“ Universidad Virtual CNCI">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">SubtÃ­tulo</label>
                            <input type="text" id="subtitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Universidad Virtual CNCI">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Departamento</label>
                            <input type="text" id="department" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Departamento de Servicios Estudiantiles">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">DescripciÃ³n</label>
                            <input type="text" id="description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Consulta tu desempeÃ±o del mÃ³dulo de manera detallada ingresando tu usuario">
                        </div>
                        <div class="md:col-span-2">
                            <button id="saveLoginTexts" class="bg-[#2a6aff] hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-all">
                                ğŸ’¾ Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Usuarios -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">ğŸ‘¥ Tabla de EdiciÃ³n de Usuarios</h2>
                        <button id="addUserBtn" class="bg-[#ff8500] hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-all">
                            â• AÃ±adir Usuario
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Usuario</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nombre</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ContraseÃ±a</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Puntaje General</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Comentarios</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Los usuarios se cargarÃ¡n dinÃ¡micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SecciÃ³n de CategorÃ­as -->
                <div class="mb-8 bg-gray-50 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ EdiciÃ³n de CategorÃ­as y Criterios de EvaluaciÃ³n</h2>
                        <button id="editCategoriesBtn" class="bg-[#2a6aff] hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-all">
                            âœï¸ Editar CategorÃ­as
                        </button>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="text-blue-600">ğŸ”„</div>
                            <div>
                                <h4 class="font-semibold text-blue-800">SincronizaciÃ³n AutomÃ¡tica</h4>
                                <p class="text-sm text-blue-600">Los cambios en categorÃ­as y criterios se aplicarÃ¡n automÃ¡ticamente a todos los usuarios existentes.</p>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Modales (mantienen la misma estructura) -->
    <!-- Modal AÃ±adir/Editar Usuario -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="userModalTitle" class="text-xl font-bold text-gray-800">â• AÃ±adir Usuario</h3>
                <button id="closeUserModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="userForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ID Usuario</label>
                    <input type="text" id="userId" required placeholder="usuario01, usuario02..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nombre</label>
                    <input type="text" id="userNameInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Puntaje General (Calculado AutomÃ¡ticamente)</label>
                    <input type="text" id="userGeneralScore" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600" placeholder="Se calcula automÃ¡ticamente del promedio de categorÃ­as">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ContraseÃ±a</label>
                    <input type="password" id="userPassword" placeholder="Dejar vacÃ­o para mantener actual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                    <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Dejar vacÃ­o para no cambiar la contraseÃ±a</p>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Comentarios</label>
                    <textarea id="userComments" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-[#2a6aff] hover:bg-blue-600 text-white py-2 rounded-lg transition-all">
                        ğŸ’¾ Guardar
                    </button>
                    <button type="button" id="cancelUserModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        âŒ Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalles de Usuario -->
    <div id="userDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ğŸ“Š Detalles del Usuario</h3>
                <button id="closeDetailsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="userDetailsForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">ID Usuario</label>
                        <input type="text" id="detailsUserId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nombre</label>
                        <input type="text" id="detailsUserName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Puntaje General (Calculado AutomÃ¡ticamente)</label>
                        <input type="text" id="detailsGeneralScore" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600" placeholder="Se calcula del promedio de categorÃ­as">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Rol</label>
                        <select id="detailsUserRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nueva ContraseÃ±a</label>
                        <input type="password" id="detailsUserPassword" placeholder="Dejar vacÃ­o para mantener actual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Solo completar si deseas cambiar la contraseÃ±a</p>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Comentarios Generales</label>
                    <textarea id="detailsGeneralComments" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                </div>
                <!-- SecciÃ³n de Insignias -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">ğŸ† Insignias del Usuario</h4>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
                            <input type="checkbox" id="badgeExcellence" class="mb-2">
                            <div class="text-3xl mb-2">ğŸ¥‡</div>
                            <label for="badgeExcellence" class="font-semibold text-yellow-800 cursor-pointer">Excelencia</label>
                            <p class="text-xs text-yellow-600 mt-1">CalificaciÃ³n superior a 90</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                            <input type="checkbox" id="badgeCommunicator" class="mb-2">
                            <div class="text-3xl mb-2">ğŸ“</div>
                            <label for="badgeCommunicator" class="font-semibold text-blue-800 cursor-pointer">Comunicador</label>
                            <p class="text-xs text-blue-600 mt-1">Excelente en llamadas</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg text-center">
                            <input type="checkbox" id="badgeConsistent" class="mb-2">
                            <div class="text-3xl mb-2">â­</div>
                            <label for="badgeConsistent" class="font-semibold text-green-800 cursor-pointer">Consistente</label>
                            <p class="text-xs text-green-600 mt-1">DesempeÃ±o estable</p>
                        </div>
                    </div>
                </div>

                <!-- SecciÃ³n de Plan de Trabajo -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ Plan de Mejora Personalizado</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">ğŸ¯ Objetivos del PrÃ³ximo PerÃ­odo</label>
                            <textarea id="userObjectives" rows="3" placeholder="Ej: Mejorar seguimiento a poblaciÃ³n morosa, Incrementar reingresos..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">ğŸ“š Recursos Recomendados</label>
                            <textarea id="userResources" rows="3" placeholder="Ej: Manual de retenciÃ³n estudiantil, Curso de comunicaciÃ³n efectiva..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">ğŸ’¡ Notas Adicionales</label>
                            <textarea id="userAdditionalNotes" rows="2" placeholder="Observaciones especiales, fortalezas destacadas..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                        </div>
                    </div>
                </div>

                <div id="categoriesSection">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ CategorÃ­as de EvaluaciÃ³n</h4>
                    <div id="categoriesContainer" class="space-y-4">
                        <!-- Las categorÃ­as se cargarÃ¡n dinÃ¡micamente -->
                    </div>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-[#2a6aff] hover:bg-blue-600 text-white py-2 rounded-lg transition-all">
                        ğŸ’¾ Guardar Cambios
                    </button>
                    <button type="button" id="cancelDetailsModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        âŒ Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal ConfirmaciÃ³n Vaciar Tabla -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-6xl mb-4">âš ï¸</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar AcciÃ³n</h3>
                <p class="text-gray-600 mb-6">Â¿EstÃ¡s seguro de que deseas eliminar todos los usuarios? Esta acciÃ³n no se puede deshacer.</p>
                <div class="flex space-x-4">
                    <button id="confirmClear" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition-all">
                        ğŸ—‘ï¸ SÃ­, Eliminar
                    </button>
                    <button id="cancelClear" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        âŒ Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal AÃ±adir Admin -->
    <div id="addAdminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ğŸ‘¨â€ğŸ’¼ AÃ±adir Nuevo Administrador</h3>
                <button id="closeAddAdminModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="addAdminForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ID Administrador</label>
                    <input type="text" id="newAdminId" required placeholder="Ej: Admin09" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nombre Completo</label>
                    <input type="text" id="newAdminName" required placeholder="Ej: Juan PÃ©rez GarcÃ­a" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Departamento</label>
                    <input type="text" id="newAdminDepartment" required placeholder="Ej: Departamento de Operaciones" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ContraseÃ±a</label>
                    <input type="password" id="newAdminPassword" required placeholder="ContraseÃ±a del administrador" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-all">
                        â• Crear Administrador
                    </button>
                    <button type="button" id="cancelAddAdminModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        âŒ Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestionar Admins -->
    <div id="manageAdminsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">âš™ï¸ Gestionar Administradores</h3>
                <button id="closeManageAdminsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID Admin</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nombre</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Departamento</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Usuarios</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="adminsTableBody">
                        <!-- Los administradores se cargarÃ¡n dinÃ¡micamente -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeManageAdminsBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-all">
                    âœ… Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal ConfirmaciÃ³n Eliminar Admin -->
    <div id="confirmDeleteAdminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-6xl mb-4">âš ï¸</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar EliminaciÃ³n</h3>
                <p class="text-gray-600 mb-2">Â¿EstÃ¡s seguro de que deseas eliminar al administrador:</p>
                <p id="adminToDeleteName" class="font-semibold text-red-600 mb-4"></p>
                <p class="text-sm text-gray-500 mb-6">Esta acciÃ³n tambiÃ©n eliminarÃ¡ todos los usuarios asociados a este administrador.</p>
                <div class="flex space-x-4">
                    <button id="confirmDeleteAdmin" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition-all">
                        ğŸ—‘ï¸ SÃ­, Eliminar
                    </button>
                    <button id="cancelDeleteAdmin" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        âŒ Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar CategorÃ­as -->
    <div id="categoriesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ Editar CategorÃ­as y Criterios</h3>
                <button id="closeCategoriesModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <button id="addCategoryBtn" class="bg-[#ff8500] hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all">
                    â• AÃ±adir CategorÃ­a
                </button>
            </div>
            <div id="categoriesEditContainer" class="space-y-4 mb-6">
                <!-- Las categorÃ­as se cargarÃ¡n dinÃ¡micamente -->
            </div>
            <div class="flex space-x-4">
                <button id="saveCategoriesBtn" class="flex-1 bg-[#2a6aff] hover:bg-blue-600 text-white py-2 rounded-lg transition-all">
                    ğŸ’¾ Guardar Cambios
                </button>
                <button id="cancelCategoriesBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                    âŒ Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard" class="min-h-screen p-6 hidden">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š Dashboard de EvaluaciÃ³n</h1>
                        <p class="text-gray-600 mt-1">Bienvenido, <span id="userName" class="text-[#2a6aff] font-semibold"></span></p>
                    </div>
                    <button id="backToLogin" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-all">
                        â† Volver
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-2xl shadow-2xl mb-6 fade-in">
                <div class="flex border-b border-gray-200">
                    <button class="tab-button tab-active px-6 py-4 font-semibold rounded-tl-2xl transition-all" data-tab="resumen">
                        ğŸ“ˆ Resumen General
                    </button>
                    <button class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-[#2a6aff] transition-all" data-tab="insignias">
                        ğŸ† Insignias
                    </button>
                    <button class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-[#2a6aff] rounded-tr-2xl transition-all" data-tab="plan">
                        ğŸ“‹ Plan de Trabajo
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Resumen General -->
                    <div id="resumen" class="tab-content">
                        <div class="grid md:grid-cols-1 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-[#2a6aff] to-blue-600 text-white p-6 rounded-xl card-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold mb-2">ğŸ¯ CalificaciÃ³n General</h3>
                                        <p class="text-3xl font-bold" id="generalScore">--</p>
                                    </div>
                                    <div class="text-4xl opacity-80">ğŸ“Š</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“‹ CategorÃ­as y Criterios de EvaluaciÃ³n</h3>
                            <div id="evaluationCategories" class="grid gap-6">
                                <!-- Las categorÃ­as se cargarÃ¡n dinÃ¡micamente -->
                            </div>
                        </div>

                        <div class="mt-8 bg-gray-50 p-6 rounded-xl">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">ğŸ’¬ Comentarios Generales</h4>
                            <p id="generalComments" class="text-gray-600">Cargando comentarios...</p>
                        </div>
                    </div>

                    <!-- Insignias -->
                    <div id="insignias" class="tab-content hidden">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ† Mis Insignias</h3>
                        <div id="userBadges" class="grid md:grid-cols-3 gap-6 mb-8">
                            <!-- Las insignias se cargarÃ¡n dinÃ¡micamente -->
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“‹ Todas las Insignias Disponibles</h4>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="bg-yellow-50 border-2 border-yellow-200 p-6 rounded-xl text-center opacity-60">
                                    <div class="text-4xl mb-3">ğŸ¥‡</div>
                                    <h4 class="font-semibold text-yellow-800">Excelencia</h4>
                                    <p class="text-sm text-yellow-600 mt-2">CalificaciÃ³n superior a 90</p>
                                </div>
                                <div class="bg-blue-50 border-2 border-blue-200 p-6 rounded-xl text-center opacity-60">
                                    <div class="text-4xl mb-3">ğŸ“</div>
                                    <h4 class="font-semibold text-blue-800">Comunicador</h4>
                                    <p class="text-sm text-blue-600 mt-2">Excelente en llamadas</p>
                                </div>
                                <div class="bg-green-50 border-2 border-green-200 p-6 rounded-xl text-center opacity-60">
                                    <div class="text-4xl mb-3">â­</div>
                                    <h4 class="font-semibold text-green-800">Consistente</h4>
                                    <p class="text-sm text-green-600 mt-2">DesempeÃ±o estable</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Plan de Trabajo -->
                    <div id="plan" class="tab-content hidden">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“‹ Mi Plan de Mejora Personalizado</h3>
                        <div class="space-y-6">
                            <div class="bg-blue-50 border-l-4 border-[#2a6aff] p-6 rounded-r-lg">
                                <h4 class="font-semibold text-[#2a6aff] mb-3">ğŸ¯ Objetivos del PrÃ³ximo PerÃ­odo</h4>
                                <div id="userObjectivesDisplay" class="text-gray-700 whitespace-pre-line">
                                    Cargando objetivos personalizados...
                                </div>
                            </div>
                            <div class="bg-orange-50 border-l-4 border-[#ff8500] p-6 rounded-r-lg">
                                <h4 class="font-semibold text-[#ff8500] mb-3">ğŸ“š Recursos Recomendados</h4>
                                <div id="userResourcesDisplay" class="text-gray-700 whitespace-pre-line">
                                    Cargando recursos personalizados...
                                </div>
                            </div>
                            <div id="additionalNotesSection" class="bg-green-50 border-l-4 border-green-500 p-6 rounded-r-lg">
                                <h4 class="font-semibold text-green-700 mb-3">ğŸ’¡ Notas Adicionales</h4>
                                <div id="userAdditionalNotesDisplay" class="text-gray-700 whitespace-pre-line">
                                    Cargando notas adicionales...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let evaluationTemplate = null;
        let allUsers = [];
        let currentEditingUser = null;
        let categoriesData = [];
        let isFirebaseInitialized = false;

        // Sistema de autenticaciÃ³n local con mÃºltiples administradores
        const defaultCredentials = {
            // Administradores
            'Admin01': { password: 'admin123', role: 'admin', name: 'Ana GarcÃ­a MartÃ­nez', department: 'Departamento AcadÃ©mico' },
            'Admin02': { password: 'admin123', role: 'admin', name: 'Carlos LÃ³pez HernÃ¡ndez', department: 'Servicios Estudiantiles' },
            'Admin03': { password: 'admin123', role: 'admin', name: 'MarÃ­a RodrÃ­guez PÃ©rez', department: 'Admisiones' },
            'Admin04': { password: 'admin123', role: 'admin', name: 'JosÃ© MartÃ­nez GonzÃ¡lez', department: 'Finanzas' },
            'Admin05': { password: 'admin123', role: 'admin', name: 'Laura SÃ¡nchez Torres', department: 'TecnologÃ­a' },
            'Admin06': { password: 'admin123', role: 'admin', name: 'Roberto DÃ­az Morales', department: 'Recursos Humanos' },
            'Admin07': { password: 'admin123', role: 'admin', name: 'Patricia JimÃ©nez Ruiz', department: 'Marketing' },
            'Admin08': { password: 'admin123', role: 'admin', name: 'Fernando Castro LÃ³pez', department: 'Calidad' },
            'Admin09': { password: 'admin123', role: 'admin', name: 'Alejandra Moreno Vega', department: 'InvestigaciÃ³n y Desarrollo' },
            'Admin10': { password: 'admin123', role: 'admin', name: 'Ricardo Herrera Silva', department: 'Relaciones Internacionales' },
            'Admin11': { password: 'admin123', role: 'admin', name: 'Gabriela RamÃ­rez Cruz', department: 'Bienestar Estudiantil' },
            'Admin12': { password: 'admin123', role: 'admin', name: 'Miguel Ãngel Vargas', department: 'EducaciÃ³n Continua' },
            'Admin13': { password: 'admin123', role: 'admin', name: 'Claudia Mendoza Ruiz', department: 'VinculaciÃ³n Empresarial' },
            
            // Usuarios de Admin01
            'usuario01_A01': { password: 'pass123', role: 'user', adminId: 'Admin01' },
            'usuario02_A01': { password: 'pass123', role: 'user', adminId: 'Admin01' },
            'usuario03_A01': { password: 'pass123', role: 'user', adminId: 'Admin01' },
            'usuario04_A01': { password: 'pass123', role: 'user', adminId: 'Admin01' },
            'usuario05_A01': { password: 'pass123', role: 'user', adminId: 'Admin01' },
            
            // Usuarios de Admin02
            'usuario01_A02': { password: 'pass123', role: 'user', adminId: 'Admin02' },
            'usuario02_A02': { password: 'pass123', role: 'user', adminId: 'Admin02' },
            'usuario03_A02': { password: 'pass123', role: 'user', adminId: 'Admin02' },
            'usuario04_A02': { password: 'pass123', role: 'user', adminId: 'Admin02' },
            'usuario05_A02': { password: 'pass123', role: 'user', adminId: 'Admin02' },
            
            // Usuarios de Admin03
            'usuario01_A03': { password: 'pass123', role: 'user', adminId: 'Admin03' },
            'usuario02_A03': { password: 'pass123', role: 'user', adminId: 'Admin03' },
            'usuario03_A03': { password: 'pass123', role: 'user', adminId: 'Admin03' },
            'usuario04_A03': { password: 'pass123', role: 'user', adminId: 'Admin03' },
            'usuario05_A03': { password: 'pass123', role: 'user', adminId: 'Admin03' },
            
            // Usuarios de Admin04
            'usuario01_A04': { password: 'pass123', role: 'user', adminId: 'Admin04' },
            'usuario02_A04': { password: 'pass123', role: 'user', adminId: 'Admin04' },
            'usuario03_A04': { password: 'pass123', role: 'user', adminId: 'Admin04' },
            'usuario04_A04': { password: 'pass123', role: 'user', adminId: 'Admin04' },
            'usuario05_A04': { password: 'pass123', role: 'user', adminId: 'Admin04' },
            
            // Usuarios de Admin05
            'usuario01_A05': { password: 'pass123', role: 'user', adminId: 'Admin05' },
            'usuario02_A05': { password: 'pass123', role: 'user', adminId: 'Admin05' },
            'usuario03_A05': { password: 'pass123', role: 'user', adminId: 'Admin05' },
            'usuario04_A05': { password: 'pass123', role: 'user', adminId: 'Admin05' },
            'usuario05_A05': { password: 'pass123', role: 'user', adminId: 'Admin05' },
            
            // Usuarios de Admin06
            'usuario01_A06': { password: 'pass123', role: 'user', adminId: 'Admin06' },
            'usuario02_A06': { password: 'pass123', role: 'user', adminId: 'Admin06' },
            'usuario03_A06': { password: 'pass123', role: 'user', adminId: 'Admin06' },
            'usuario04_A06': { password: 'pass123', role: 'user', adminId: 'Admin06' },
            'usuario05_A06': { password: 'pass123', role: 'user', adminId: 'Admin06' },
            
            // Usuarios de Admin07
            'usuario01_A07': { password: 'pass123', role: 'user', adminId: 'Admin07' },
            'usuario02_A07': { password: 'pass123', role: 'user', adminId: 'Admin07' },
            'usuario03_A07': { password: 'pass123', role: 'user', adminId: 'Admin07' },
            'usuario04_A07': { password: 'pass123', role: 'user', adminId: 'Admin07' },
            'usuario05_A07': { password: 'pass123', role: 'user', adminId: 'Admin07' },
            
            // Usuarios de Admin08
            'usuario01_A08': { password: 'pass123', role: 'user', adminId: 'Admin08' },
            'usuario02_A08': { password: 'pass123', role: 'user', adminId: 'Admin08' },
            'usuario03_A08': { password: 'pass123', role: 'user', adminId: 'Admin08' },
            'usuario04_A08': { password: 'pass123', role: 'user', adminId: 'Admin08' },
            'usuario05_A08': { password: 'pass123', role: 'user', adminId: 'Admin08' },
            
            // Usuarios de Admin09
            'usuario01_A09': { password: 'pass123', role: 'user', adminId: 'Admin09' },
            'usuario02_A09': { password: 'pass123', role: 'user', adminId: 'Admin09' },
            'usuario03_A09': { password: 'pass123', role: 'user', adminId: 'Admin09' },
            'usuario04_A09': { password: 'pass123', role: 'user', adminId: 'Admin09' },
            'usuario05_A09': { password: 'pass123', role: 'user', adminId: 'Admin09' },
            
            // Usuarios de Admin10
            'usuario01_A10': { password: 'pass123', role: 'user', adminId: 'Admin10' },
            'usuario02_A10': { password: 'pass123', role: 'user', adminId: 'Admin10' },
            'usuario03_A10': { password: 'pass123', role: 'user', adminId: 'Admin10' },
            'usuario04_A10': { password: 'pass123', role: 'user', adminId: 'Admin10' },
            'usuario05_A10': { password: 'pass123', role: 'user', adminId: 'Admin10' },
            
            // Usuarios de Admin11
            'usuario01_A11': { password: 'pass123', role: 'user', adminId: 'Admin11' },
            'usuario02_A11': { password: 'pass123', role: 'user', adminId: 'Admin11' },
            'usuario03_A11': { password: 'pass123', role: 'user', adminId: 'Admin11' },
            'usuario04_A11': { password: 'pass123', role: 'user', adminId: 'Admin11' },
            'usuario05_A11': { password: 'pass123', role: 'user', adminId: 'Admin11' },
            
            // Usuarios de Admin12
            'usuario01_A12': { password: 'pass123', role: 'user', adminId: 'Admin12' },
            'usuario02_A12': { password: 'pass123', role: 'user', adminId: 'Admin12' },
            'usuario03_A12': { password: 'pass123', role: 'user', adminId: 'Admin12' },
            'usuario04_A12': { password: 'pass123', role: 'user', adminId: 'Admin12' },
            'usuario05_A12': { password: 'pass123', role: 'user', adminId: 'Admin12' },
            
            // Usuarios de Admin13
            'usuario01_A13': { password: 'pass123', role: 'user', adminId: 'Admin13' },
            'usuario02_A13': { password: 'pass123', role: 'user', adminId: 'Admin13' },
            'usuario03_A13': { password: 'pass123', role: 'user', adminId: 'Admin13' },
            'usuario04_A13': { password: 'pass123', role: 'user', adminId: 'Admin13' },
            'usuario05_A13': { password: 'pass123', role: 'user', adminId: 'Admin13' }
        };

        // Mapeo de nicknames a emails (para Firebase cuando estÃ© disponible)
        const nicknameToEmail = {
            'admin': 'admin@cnci.edu.mx',
            'usuario01': 'usuario01@cnci.edu.mx',
            'usuario02': 'usuario02@cnci.edu.mx',
            'usuario03': 'usuario03@cnci.edu.mx',
            'usuario04': 'usuario04@cnci.edu.mx',
            'usuario05': 'usuario05@cnci.edu.mx',
            'usuario06': 'usuario06@cnci.edu.mx',
            'usuario07': 'usuario07@cnci.edu.mx',
            'usuario08': 'usuario08@cnci.edu.mx',
            'usuario09': 'usuario09@cnci.edu.mx',
            'usuario10': 'usuario10@cnci.edu.mx',
            'usuario11': 'usuario11@cnci.edu.mx',
            'usuario12': 'usuario12@cnci.edu.mx',
            'usuario13': 'usuario13@cnci.edu.mx',
            'usuario14': 'usuario14@cnci.edu.mx',
            'usuario15': 'usuario15@cnci.edu.mx',
            'usuario16': 'usuario16@cnci.edu.mx',
            'usuario17': 'usuario17@cnci.edu.mx',
            'usuario18': 'usuario18@cnci.edu.mx'
        };

        // AlmacÃ©n de credenciales (se sincroniza con Firebase cuando estÃ¡ disponible)
        let userCredentials = { ...defaultCredentials };

        // Datos por defecto para inicializaciÃ³n
        const defaultData = {
            loginTexts: {
                mainTitle: 'EvaluaciÃ³n Modular',
                subtitle: 'Universidad Virtual CNCI',
                department: 'Departamento de Servicios Estudiantiles',
                description: 'Consulta tu desempeÃ±o del mÃ³dulo de manera detallada ingresando tu usuario'
            },
            evaluationTemplate: {
                categories: [
                    {
                        name: 'RETENCIÃ“N',
                        criteria: ['Seguimiento a poblaciÃ³n morosa', 'Total de bajas de alumnos con morosidad', 'Uso adecuado y oportuno de la columna de retenciÃ³n de CRM', 'RetenciÃ³n y bajas pagadas']
                    },
                    {
                        name: 'REINCORPORACIÃ“N',
                        criteria: ['Bajas por no pago', 'BÃºsqueda y difusiÃ³n de promociones', 'Registro y seguimiento', 'Cierre de prospectos', 'Total de reingresos']
                    },
                    {
                        name: 'PROCESOS',
                        criteria: ['BÃºsqueda de alumnos por estatus y perfil: semana 1 a la semana 4', 'Procesos acadÃ©micos', 'TrÃ¡mites escolares']
                    },
                    {
                        name: 'LLAMADA',
                        criteria: ['Se presenta con su nombre e identificaciÃ³n de la Universidad', 'Maneja motivo de la llamada de manera adecuada']
                    },
                    {
                        name: 'WHATSAPP',
                        criteria: ['Emplea redacciÃ³n adecuada', 'Crea bocetos', 'Responde todos los mensajes', 'Contesta preguntas en un rango de 12 horas o menos', 'Brinda soluciones pertinentes', 'Propone llamada para una mejor explicaciÃ³n', 'Es empÃ¡tico (a)']
                    },
                    {
                        name: 'CORREO ELECTRÃ“NICO',
                        criteria: ['Emplea redacciÃ³n adecuada', 'Crea bocetos previos a enviar', 'Responde todos los mensajes', 'Contesta preguntas en un rango de 12 horas o menos', 'Atiende en tiempo la asignaciÃ³n de correos institucionales', 'Brinda soluciones pertinentes', 'Propone llamada para una mejor explicaciÃ³n', 'Es empÃ¡tico (a)', 'Mantiene control sobre sus emociones en casos difÃ­ciles']
                    },
                    {
                        name: 'VIVA ENGAGE',
                        criteria: ['La reuniÃ³n previa a la publicaciÃ³n se realiza de forma exitosa', 'Se nota una excelente organizaciÃ³n y trabajo en equipo', 'Se utilizan imÃ¡genes, videos o elementos grÃ¡ficos llamativos y bien diseÃ±ados', 'Se publica en la fecha establecida sin retrasos']
                    },
                    {
                        name: 'ACTIVIDADES ADMINISTRATIVAS',
                        criteria: ['Asigna y actualiza perfiles', 'Especifica a travÃ©s de que medio abordÃ³ al alumno', 'Registra en tiempo (diario) sus actividades en el reporte de seguimiento CRM', 'Organiza sus tiempos para cumplir con el % mÃ­nimo (90%) de contactaciÃ³n', 'Logra el % mÃ­nimo de contactaciÃ³n']
                    }
                ]
            },
            defaultUsers: [
                // Usuarios de Admin01
                {
                    username: 'usuario01_A01',
                    name: 'MarÃ­a GonzÃ¡lez PÃ©rez',
                    role: 'user',
                    adminId: 'Admin01',
                    password: 'pass123',
                    generalScore: 87,
                    generalComments: 'Excelente desempeÃ±o en retenciÃ³n y reincorporaciÃ³n. Se destaca por su seguimiento oportuno a estudiantes morosos y uso efectivo del CRM.',
                    badges: {
                        excellence: false,
                        communicator: true,
                        consistent: true
                    },
                    workPlan: {
                        objectives: 'Mejorar seguimiento a poblaciÃ³n morosa\nIncrementar reingresos de estudiantes\nOptimizar procesos acadÃ©micos',
                        resources: 'Manual de retenciÃ³n estudiantil\nCurso de comunicaciÃ³n efectiva\nTaller de uso de CRM',
                        additionalNotes: 'Estudiante destacada en comunicaciÃ³n. Continuar fortaleciendo habilidades tÃ©cnicas.'
                    },
                    categories: {
                        'RETENCIÃ“N': { 
                            score: 9.0, 
                            criteria: [
                                { name: 'Seguimiento a poblaciÃ³n morosa', score: 9.0 },
                                { name: 'Total de bajas de alumnos con morosidad', score: 8.5 },
                                { name: 'Uso adecuado y oportuno de la columna de retenciÃ³n de CRM', score: 9.5 },
                                { name: 'RetenciÃ³n y bajas pagadas', score: 9.0 }
                            ]
                        },
                        'REINCORPORACIÃ“N': { 
                            score: 8.5, 
                            criteria: [
                                { name: 'Bajas por no pago', score: 8.0 },
                                { name: 'BÃºsqueda y difusiÃ³n de promociones', score: 9.0 },
                                { name: 'Registro y seguimiento', score: 8.5 },
                                { name: 'Cierre de prospectos', score: 8.0 },
                                { name: 'Total de reingresos', score: 9.0 }
                            ]
                        },
                        'PROCESOS': { 
                            score: 8.8, 
                            criteria: [
                                { name: 'BÃºsqueda de alumnos por estatus y perfil: semana 1 a la semana 4', score: 9.0 },
                                { name: 'Procesos acadÃ©micos', score: 8.5 },
                                { name: 'TrÃ¡mites escolares', score: 9.0 }
                            ]
                        },
                        'LLAMADA': { 
                            score: 9.2, 
                            criteria: [
                                { name: 'Se presenta con su nombre e identificaciÃ³n de la Universidad', score: 9.5 },
                                { name: 'Maneja motivo de la llamada de manera adecuada', score: 8.9 }
                            ]
                        },
                        'WHATSAPP': { 
                            score: 8.3, 
                            criteria: [
                                { name: 'Emplea redacciÃ³n adecuada', score: 8.5 },
                                { name: 'Crea bocetos', score: 8.0 },
                                { name: 'Responde todos los mensajes', score: 9.0 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 8.0 },
                                { name: 'Brinda soluciones pertinentes', score: 8.5 },
                                { name: 'Propone llamada para una mejor explicaciÃ³n', score: 8.0 },
                                { name: 'Es empÃ¡tico (a)', score: 8.1 }
                            ]
                        },
                        'CORREO ELECTRÃ“NICO': { 
                            score: 8.9, 
                            criteria: [
                                { name: 'Emplea redacciÃ³n adecuada', score: 9.0 },
                                { name: 'Crea bocetos previos a enviar', score: 8.5 },
                                { name: 'Responde todos los mensajes', score: 9.0 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 9.5 },
                                { name: 'Atiende en tiempo la asignaciÃ³n de correos institucionales', score: 8.5 },
                                { name: 'Brinda soluciones pertinentes', score: 9.0 },
                                { name: 'Propone llamada para una mejor explicaciÃ³n', score: 8.5 },
                                { name: 'Es empÃ¡tico (a)', score: 9.0 },
                                { name: 'Mantiene control sobre sus emociones en casos difÃ­ciles', score: 9.1 }
                            ]
                        },
                        'VIVA ENGAGE': { 
                            score: 8.6, 
                            criteria: [
                                { name: 'La reuniÃ³n previa a la publicaciÃ³n se realiza de forma exitosa', score: 8.5 },
                                { name: 'Se nota una excelente organizaciÃ³n y trabajo en equipo', score: 9.0 },
                                { name: 'Se utilizan imÃ¡genes, videos o elementos grÃ¡ficos llamativos y bien diseÃ±ados', score: 8.0 },
                                { name: 'Se publica en la fecha establecida sin retrasos', score: 8.9 }
                            ]
                        },
                        'ACTIVIDADES ADMINISTRATIVAS': { 
                            score: 9.1, 
                            criteria: [
                                { name: 'Asigna y actualiza perfiles', score: 9.0 },
                                { name: 'Especifica a travÃ©s de que medio abordÃ³ al alumno', score: 9.5 },
                                { name: 'Registra en tiempo (diario) sus actividades en el reporte de seguimiento CRM', score: 9.0 },
                                { name: 'Organiza sus tiempos para cumplir con el % mÃ­nimo (90%) de contactaciÃ³n', score: 8.5 },
                                { name: 'Logra el % mÃ­nimo de contactaciÃ³n', score: 9.5 }
                            ]
                        }
                    }
                },
                {
                    username: 'usuario02_A01',
                    name: 'Carlos RodrÃ­guez LÃ³pez',
                    role: 'user',
                    adminId: 'Admin01',
                    password: 'pass123',
                    generalScore: 92,
                    generalComments: 'Muy buen desempeÃ±o general. Excelente manejo de procesos acadÃ©micos y comunicaciÃ³n con estudiantes.',
                    badges: {
                        excellence: true,
                        communicator: true,
                        consistent: true
                    },
                    workPlan: {
                        objectives: 'Mantener excelencia en todas las Ã¡reas\nMentorÃ­a a nuevos compaÃ±eros\nLiderar proyectos de mejora continua',
                        resources: 'CertificaciÃ³n avanzada en CRM\nCurso de liderazgo\nTaller de mentoring',
                        additionalNotes: 'Empleado modelo con todas las insignias. Candidato ideal para roles de liderazgo.'
                    },
                    categories: {
                        'RETENCIÃ“N': { 
                            score: 9.5, 
                            criteria: [
                                { name: 'Seguimiento a poblaciÃ³n morosa', score: 9.5 },
                                { name: 'Total de bajas de alumnos con morosidad', score: 9.0 },
                                { name: 'Uso adecuado y oportuno de la columna de retenciÃ³n de CRM', score: 10.0 },
                                { name: 'RetenciÃ³n y bajas pagadas', score: 9.5 }
                            ]
                        },
                        'REINCORPORACIÃ“N': { 
                            score: 9.0, 
                            criteria: [
                                { name: 'Bajas por no pago', score: 9.0 },
                                { name: 'BÃºsqueda y difusiÃ³n de promociones', score: 9.5 },
                                { name: 'Registro y seguimiento', score: 8.5 },
                                { name: 'Cierre de prospectos', score: 9.0 },
                                { name: 'Total de reingresos', score: 9.0 }
                            ]
                        },
                        'PROCESOS': { 
                            score: 9.1, 
                            criteria: [
                                { name: 'BÃºsqueda de alumnos por estatus y perfil: semana 1 a la semana 4', score: 9.0 },
                                { name: 'Procesos acadÃ©micos', score: 9.5 },
                                { name: 'TrÃ¡mites escolares', score: 8.8 }
                            ]
                        },
                        'LLAMADA': { 
                            score: 9.4, 
                            criteria: [
                                { name: 'Se presenta con su nombre e identificaciÃ³n de la Universidad', score: 9.5 },
                                { name: 'Maneja motivo de la llamada de manera adecuada', score: 9.3 }
                            ]
                        },
                        'WHATSAPP': { 
                            score: 8.8, 
                            criteria: [
                                { name: 'Emplea redacciÃ³n adecuada', score: 9.0 },
                                { name: 'Crea bocetos', score: 8.5 },
                                { name: 'Responde todos los mensajes', score: 9.5 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 8.5 },
                                { name: 'Brinda soluciones pertinentes', score: 9.0 },
                                { name: 'Propone llamada para una mejor explicaciÃ³n', score: 8.5 },
                                { name: 'Es empÃ¡tico (a)', score: 8.6 }
                            ]
                        },
                        'CORREO ELECTRÃ“NICO': { 
                            score: 9.3, 
                            criteria: [
                                { name: 'Emplea redacciÃ³n adecuada', score: 9.5 },
                                { name: 'Crea bocetos previos a enviar', score: 9.0 },
                                { name: 'Responde todos los mensajes', score: 9.5 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 9.0 },
                                { name: 'Atiende en tiempo la asignaciÃ³n de correos institucionales', score: 9.5 },
                                { name: 'Brinda soluciones pertinentes', score: 9.0 },
                                { name: 'Propone llamada para una mejor explicaciÃ³n', score: 9.5 },
                                { name: 'Es empÃ¡tico (a)', score: 9.0 },
                                { name: 'Mantiene control sobre sus emociones en casos difÃ­ciles', score: 9.7 }
                            ]
                        },
                        'VIVA ENGAGE': { 
                            score: 8.9, 
                            criteria: [
                                { name: 'La reuniÃ³n previa a la publicaciÃ³n se realiza de forma exitosa', score: 9.0 },
                                { name: 'Se nota una excelente organizaciÃ³n y trabajo en equipo', score: 9.5 },
                                { name: 'Se utilizan imÃ¡genes, videos o elementos grÃ¡ficos llamativos y bien diseÃ±ados', score: 8.0 },
                                { name: 'Se publica en la fecha establecida sin retrasos', score: 9.1 }
                            ]
                        },
                        'ACTIVIDADES ADMINISTRATIVAS': { 
                            score: 9.6, 
                            criteria: [
                                { name: 'Asigna y actualiza perfiles', score: 9.5 },
                                { name: 'Especifica a travÃ©s de que medio abordÃ³ al alumno', score: 10.0 },
                                { name: 'Registra en tiempo (diario) sus actividades en el reporte de seguimiento CRM', score: 9.5 },
                                { name: 'Organiza sus tiempos para cumplir con el % mÃ­nimo (90%) de contactaciÃ³n', score: 9.0 },
                                { name: 'Logra el % mÃ­nimo de contactaciÃ³n', score: 10.0 }
                            ]
                        }
                    }
                },
                // Usuarios adicionales de Admin01
                {
                    username: 'usuario03_A01',
                    name: 'Ana MartÃ­nez Silva',
                    role: 'user',
                    adminId: 'Admin01',
                    password: 'pass123',
                    generalScore: 85,
                    generalComments: 'Buen desempeÃ±o general con oportunidades de mejora en comunicaciÃ³n digital.',
                    badges: { excellence: false, communicator: false, consistent: true },
                    workPlan: {
                        objectives: 'Mejorar redacciÃ³n en correos\nOptimizar tiempos de respuesta',
                        resources: 'Curso de redacciÃ³n profesional\nTaller de gestiÃ³n del tiempo',
                        additionalNotes: 'Muestra consistencia en sus tareas diarias.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario04_A01',
                    name: 'Luis Fernando Torres',
                    role: 'user',
                    adminId: 'Admin01',
                    password: 'pass123',
                    generalScore: 78,
                    generalComments: 'DesempeÃ±o satisfactorio con necesidad de reforzar procesos administrativos.',
                    badges: { excellence: false, communicator: true, consistent: false },
                    workPlan: {
                        objectives: 'Mejorar registro en CRM\nIncrementar seguimiento a estudiantes',
                        resources: 'Manual de procesos CRM\nCapacitaciÃ³n en seguimiento estudiantil',
                        additionalNotes: 'Excelente en comunicaciÃ³n telefÃ³nica.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario05_A01',
                    name: 'Carmen Beatriz Herrera',
                    role: 'user',
                    adminId: 'Admin01',
                    password: 'pass123',
                    generalScore: 90,
                    generalComments: 'Excelente desempeÃ±o en todas las Ã¡reas evaluadas.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Mantener nivel de excelencia\nMentorÃ­a a compaÃ±eros nuevos',
                        resources: 'CertificaciÃ³n avanzada\nCurso de liderazgo',
                        additionalNotes: 'Candidata para promociÃ³n a roles de supervisiÃ³n.'
                    },
                    categories: {}
                },
                // Usuarios de Admin02
                {
                    username: 'usuario01_A02',
                    name: 'Roberto SÃ¡nchez Morales',
                    role: 'user',
                    adminId: 'Admin02',
                    password: 'pass123',
                    generalScore: 82,
                    generalComments: 'Buen desempeÃ±o en servicios estudiantiles con enfoque en retenciÃ³n.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Incrementar tasa de retenciÃ³n\nMejorar seguimiento post-contacto',
                        resources: 'Estrategias de retenciÃ³n estudiantil\nTÃ©cnicas de seguimiento efectivo',
                        additionalNotes: 'Especialista en comunicaciÃ³n con estudiantes.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario02_A02',
                    name: 'SofÃ­a RamÃ­rez Castro',
                    role: 'user',
                    adminId: 'Admin02',
                    password: 'pass123',
                    generalScore: 88,
                    generalComments: 'Excelente manejo de casos complejos y resoluciÃ³n de problemas estudiantiles.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Desarrollar protocolos de atenciÃ³n\nCapacitar a nuevos miembros del equipo',
                        resources: 'Curso de resoluciÃ³n de conflictos\nTaller de atenciÃ³n al cliente',
                        additionalNotes: 'Referente en manejo de situaciones difÃ­ciles.'
                    },
                    categories: {}
                },
                // Usuarios adicionales de Admin02-08 (datos bÃ¡sicos)
                {
                    username: 'usuario03_A02',
                    name: 'Diego FernÃ¡ndez Ruiz',
                    role: 'user',
                    adminId: 'Admin02',
                    password: 'pass123',
                    generalScore: 84,
                    generalComments: 'Buen desempeÃ±o en servicios estudiantiles con enfoque en seguimiento.',
                    badges: { excellence: false, communicator: true, consistent: false },
                    workPlan: { objectives: 'Mejorar consistencia en seguimiento', resources: 'CapacitaciÃ³n en CRM', additionalNotes: 'Potencial de crecimiento alto.' },
                    categories: {}
                },
                {
                    username: 'usuario04_A02',
                    name: 'Valeria Morales JimÃ©nez',
                    role: 'user',
                    adminId: 'Admin02',
                    password: 'pass123',
                    generalScore: 91,
                    generalComments: 'Excelente en todas las Ã¡reas de servicios estudiantiles.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: { objectives: 'Liderar proyectos de mejora', resources: 'Curso de liderazgo', additionalNotes: 'Candidata para promociÃ³n.' },
                    categories: {}
                },
                {
                    username: 'usuario05_A02',
                    name: 'AndrÃ©s Castillo Vega',
                    role: 'user',
                    adminId: 'Admin02',
                    password: 'pass123',
                    generalScore: 79,
                    generalComments: 'DesempeÃ±o satisfactorio con oportunidades de mejora.',
                    badges: { excellence: false, communicator: false, consistent: true },
                    workPlan: { objectives: 'Mejorar habilidades de comunicaciÃ³n', resources: 'Taller de comunicaciÃ³n efectiva', additionalNotes: 'Trabajador constante y dedicado.' },
                    categories: {}
                },
                // Usuarios de Admin09 - InvestigaciÃ³n y Desarrollo
                {
                    username: 'usuario01_A09',
                    name: 'Dr. Alejandro Mendoza Torres',
                    role: 'user',
                    adminId: 'Admin09',
                    password: 'pass123',
                    generalScore: 94,
                    generalComments: 'Excelente investigador con mÃºltiples publicaciones y proyectos innovadores.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Liderar proyecto de IA educativa\nMentorÃ­a a investigadores junior',
                        resources: 'Conferencias internacionales\nAcceso a bases de datos especializadas',
                        additionalNotes: 'Investigador estrella del departamento con reconocimiento internacional.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario02_A09',
                    name: 'Dra. Carolina Espinoza Ruiz',
                    role: 'user',
                    adminId: 'Admin09',
                    password: 'pass123',
                    generalScore: 89,
                    generalComments: 'Especialista en metodologÃ­as educativas innovadoras y tecnologÃ­a aplicada.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Desarrollar plataforma de aprendizaje adaptativo\nPublicar en revistas indexadas',
                        resources: 'Software de anÃ¡lisis estadÃ­stico\nCapacitaciÃ³n en machine learning',
                        additionalNotes: 'Experta en anÃ¡lisis de datos educativos.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario03_A09',
                    name: 'Ing. Roberto Silva MartÃ­n',
                    role: 'user',
                    adminId: 'Admin09',
                    password: 'pass123',
                    generalScore: 86,
                    generalComments: 'Desarrollador de soluciones tecnolÃ³gicas para educaciÃ³n virtual.',
                    badges: { excellence: false, communicator: false, consistent: true },
                    workPlan: {
                        objectives: 'Optimizar plataforma LMS\nImplementar realidad virtual en cursos',
                        resources: 'Herramientas de desarrollo VR\nCursos de programaciÃ³n avanzada',
                        additionalNotes: 'Especialista tÃ©cnico con visiÃ³n innovadora.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario04_A09',
                    name: 'Mtra. Fernanda LÃ³pez Herrera',
                    role: 'user',
                    adminId: 'Admin09',
                    password: 'pass123',
                    generalScore: 92,
                    generalComments: 'Investigadora en psicologÃ­a educativa y neuroaprendizaje.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Estudiar impacto neurolÃ³gico del e-learning\nDesarrollar tÃ©cnicas de evaluaciÃ³n cognitiva',
                        resources: 'Laboratorio de neurociencias\nEquipo de EEG educativo',
                        additionalNotes: 'Pionera en neuroeducaciÃ³n aplicada a entornos virtuales.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario05_A09',
                    name: 'Dr. Mauricio Guerrero SÃ¡nchez',
                    role: 'user',
                    adminId: 'Admin09',
                    password: 'pass123',
                    generalScore: 87,
                    generalComments: 'Especialista en anÃ¡lisis de big data educativo y mÃ©tricas de aprendizaje.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Implementar analytics predictivos\nDesarrollar dashboard de mÃ©tricas estudiantiles',
                        resources: 'Plataforma de big data\nCertificaciÃ³n en data science',
                        additionalNotes: 'Experto en transformar datos en insights educativos.'
                    },
                    categories: {}
                },
                // Usuarios de Admin10 - Relaciones Internacionales
                {
                    username: 'usuario01_A10',
                    name: 'Lic. Isabella MartÃ­nez Wong',
                    role: 'user',
                    adminId: 'Admin10',
                    password: 'pass123',
                    generalScore: 93,
                    generalComments: 'Coordinadora de intercambios internacionales con excelentes resultados.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Expandir convenios con universidades asiÃ¡ticas\nDesarrollar programa de doble titulaciÃ³n',
                        resources: 'Viajes de negociaciÃ³n internacional\nCurso de protocolo diplomÃ¡tico',
                        additionalNotes: 'TrilingÃ¼e con amplia red de contactos internacionales.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario02_A10',
                    name: 'Mtro. Jean-Pierre Dubois',
                    role: 'user',
                    adminId: 'Admin10',
                    password: 'pass123',
                    generalScore: 90,
                    generalComments: 'Especialista en programas europeos y acreditaciones internacionales.',
                    badges: { excellence: true, communicator: true, consistent: false },
                    workPlan: {
                        objectives: 'Obtener acreditaciÃ³n AACSB\nEstablecer oficina en ParÃ­s',
                        resources: 'ConsultorÃ­a en acreditaciones\nCapacitaciÃ³n en estÃ¡ndares europeos',
                        additionalNotes: 'Experto en sistemas educativos europeos.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario03_A10',
                    name: 'Lic. Sakura Tanaka RodrÃ­guez',
                    role: 'user',
                    adminId: 'Admin10',
                    password: 'pass123',
                    generalScore: 88,
                    generalComments: 'Coordinadora de programas con universidades japonesas y coreanas.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Implementar metodologÃ­a japonesa Kaizen\nDesarrollar intercambio tecnolÃ³gico',
                        resources: 'InmersiÃ³n cultural en JapÃ³n\nCurso de gestiÃ³n japonesa',
                        additionalNotes: 'Especialista en culturas asiÃ¡ticas y tecnologÃ­a educativa.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario04_A10',
                    name: 'Dr. Alessandro Romano GarcÃ­a',
                    role: 'user',
                    adminId: 'Admin10',
                    password: 'pass123',
                    generalScore: 85,
                    generalComments: 'Gestor de alianzas estratÃ©gicas con instituciones latinoamericanas.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Crear red universitaria latinoamericana\nDesarrollar programa de movilidad estudiantil',
                        resources: 'Conferencias regionales\nPlataforma de colaboraciÃ³n virtual',
                        additionalNotes: 'Experto en integraciÃ³n educativa regional.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario05_A10',
                    name: 'Mtra. Sarah Johnson LÃ³pez',
                    role: 'user',
                    adminId: 'Admin10',
                    password: 'pass123',
                    generalScore: 91,
                    generalComments: 'Especialista en programas con universidades estadounidenses y canadienses.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Establecer campus en CanadÃ¡\nDesarrollar programa MBA internacional',
                        resources: 'CertificaciÃ³n en educaciÃ³n norteamericana\nViajes de prospecciÃ³n',
                        additionalNotes: 'BilingÃ¼e nativa con experiencia en sistemas educativos norteamericanos.'
                    },
                    categories: {}
                },
                // Usuarios de Admin11 - Bienestar Estudiantil
                {
                    username: 'usuario01_A11',
                    name: 'Psic. Mariana Flores Delgado',
                    role: 'user',
                    adminId: 'Admin11',
                    password: 'pass123',
                    generalScore: 95,
                    generalComments: 'PsicÃ³loga educativa especializada en bienestar emocional estudiantil.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Implementar programa de salud mental\nDesarrollar app de bienestar estudiantil',
                        resources: 'CertificaciÃ³n en terapia online\nPlataforma de telepsicologÃ­a',
                        additionalNotes: 'Referente nacional en psicologÃ­a educativa virtual.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario02_A11',
                    name: 'Lic. Carlos Mendoza Ruiz',
                    role: 'user',
                    adminId: 'Admin11',
                    password: 'pass123',
                    generalScore: 87,
                    generalComments: 'Coordinador de actividades deportivas y recreativas virtuales.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Crear liga deportiva virtual\nImplementar pausas activas en clases',
                        resources: 'Plataforma de gamificaciÃ³n deportiva\nEquipamiento para streaming deportivo',
                        additionalNotes: 'Innovador en deportes virtuales y bienestar fÃ­sico.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario03_A11',
                    name: 'Nut. Andrea VÃ¡squez Torres',
                    role: 'user',
                    adminId: 'Admin11',
                    password: 'pass123',
                    generalScore: 89,
                    generalComments: 'NutriÃ³loga especializada en alimentaciÃ³n para estudiantes virtuales.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Desarrollar programa nutricional estudiantil\nCrear app de seguimiento alimentario',
                        resources: 'Software de anÃ¡lisis nutricional\nCurso de nutriciÃ³n deportiva',
                        additionalNotes: 'Experta en nutriciÃ³n para el rendimiento acadÃ©mico.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario04_A11',
                    name: 'Lic. Javier Herrera Morales',
                    role: 'user',
                    adminId: 'Admin11',
                    password: 'pass123',
                    generalScore: 83,
                    generalComments: 'Coordinador de becas y apoyo socioeconÃ³mico estudiantil.',
                    badges: { excellence: false, communicator: true, consistent: false },
                    workPlan: {
                        objectives: 'Ampliar programa de becas\nDesarrollar sistema de apoyo financiero',
                        resources: 'Plataforma de gestiÃ³n de becas\nCapacitaciÃ³n en anÃ¡lisis socioeconÃ³mico',
                        additionalNotes: 'Comprometido con la equidad educativa.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario05_A11',
                    name: 'Mtra. LucÃ­a RamÃ­rez Soto',
                    role: 'user',
                    adminId: 'Admin11',
                    password: 'pass123',
                    generalScore: 92,
                    generalComments: 'Especialista en inclusiÃ³n educativa y diversidad estudiantil.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Implementar programa de inclusiÃ³n\nDesarrollar tecnologÃ­a asistiva',
                        resources: 'Herramientas de accesibilidad\nCapacitaciÃ³n en diversidad',
                        additionalNotes: 'LÃ­der en educaciÃ³n inclusiva y accesible.'
                    },
                    categories: {}
                },
                // Usuarios de Admin12 - EducaciÃ³n Continua
                {
                    username: 'usuario01_A12',
                    name: 'Dr. Rodrigo CastaÃ±eda Vega',
                    role: 'user',
                    adminId: 'Admin12',
                    password: 'pass123',
                    generalScore: 91,
                    generalComments: 'Director de programas ejecutivos y educaciÃ³n para adultos.',
                    badges: { excellence: true, communicator: true, consistent: false },
                    workPlan: {
                        objectives: 'Lanzar MBA ejecutivo online\nDesarrollar microcrÃ©ditos acadÃ©micos',
                        resources: 'Plataforma de educaciÃ³n ejecutiva\nCertificaciÃ³n en adult learning',
                        additionalNotes: 'Experto en educaciÃ³n para profesionales en activo.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario02_A12',
                    name: 'Mtra. Elena GutiÃ©rrez Ponce',
                    role: 'user',
                    adminId: 'Admin12',
                    password: 'pass123',
                    generalScore: 88,
                    generalComments: 'Coordinadora de certificaciones profesionales y cursos especializados.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Ampliar catÃ¡logo de certificaciones\nImplementar badges digitales',
                        resources: 'Plataforma de credenciales digitales\nAlianzas con organismos certificadores',
                        additionalNotes: 'Especialista en credencializaciÃ³n y reconocimiento profesional.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario03_A12',
                    name: 'Lic. Fernando Aguilar Ramos',
                    role: 'user',
                    adminId: 'Admin12',
                    password: 'pass123',
                    generalScore: 85,
                    generalComments: 'Gestor de programas corporativos y capacitaciÃ³n empresarial.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Desarrollar universidad corporativa\nImplementar learning analytics empresarial',
                        resources: 'CRM para clientes corporativos\nPlataforma B2B de capacitaciÃ³n',
                        additionalNotes: 'Experto en soluciones de capacitaciÃ³n empresarial.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario04_A12',
                    name: 'Dra. Patricia Moreno Silva',
                    role: 'user',
                    adminId: 'Admin12',
                    password: 'pass123',
                    generalScore: 93,
                    generalComments: 'Investigadora en andragogÃ­a y metodologÃ­as para adultos.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Publicar manual de andragogÃ­a digital\nDesarrollar metodologÃ­a propia',
                        resources: 'Laboratorio de investigaciÃ³n educativa\nAcceso a journals especializados',
                        additionalNotes: 'Autoridad acadÃ©mica en educaciÃ³n de adultos.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario05_A12',
                    name: 'Ing. SebastiÃ¡n Torres Medina',
                    role: 'user',
                    adminId: 'Admin12',
                    password: 'pass123',
                    generalScore: 86,
                    generalComments: 'Desarrollador de plataformas de aprendizaje para profesionales.',
                    badges: { excellence: false, communicator: false, consistent: true },
                    workPlan: {
                        objectives: 'Crear plataforma de microlearning\nImplementar IA para personalizaciÃ³n',
                        resources: 'Herramientas de desarrollo IA\nCapacitaciÃ³n en UX/UI avanzado',
                        additionalNotes: 'Especialista en tecnologÃ­a educativa para adultos.'
                    },
                    categories: {}
                },
                // Usuarios de Admin13 - VinculaciÃ³n Empresarial
                {
                    username: 'usuario01_A13',
                    name: 'Lic. MÃ³nica Herrera Castillo',
                    role: 'user',
                    adminId: 'Admin13',
                    password: 'pass123',
                    generalScore: 94,
                    generalComments: 'Directora de alianzas estratÃ©gicas con sector empresarial.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Establecer 50 nuevas alianzas empresariales\nCrear programa de mentorÃ­as corporativas',
                        resources: 'CRM empresarial avanzado\nEventos de networking',
                        additionalNotes: 'Red de contactos empresariales de mÃ¡s de 500 ejecutivos.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario02_A13',
                    name: 'Ing. Alberto SÃ¡nchez Ruiz',
                    role: 'user',
                    adminId: 'Admin13',
                    password: 'pass123',
                    generalScore: 89,
                    generalComments: 'Coordinador de prÃ¡cticas profesionales y bolsa de trabajo.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Incrementar tasa de empleabilidad al 95%\nDesarrollar plataforma de matching laboral',
                        resources: 'Software de matching IA\nAlianzas con headhunters',
                        additionalNotes: 'Especialista en inserciÃ³n laboral y desarrollo profesional.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario03_A13',
                    name: 'Mtra. Daniela Morales LÃ³pez',
                    role: 'user',
                    adminId: 'Admin13',
                    password: 'pass123',
                    generalScore: 91,
                    generalComments: 'Gestora de proyectos de investigaciÃ³n aplicada con empresas.',
                    badges: { excellence: true, communicator: true, consistent: false },
                    workPlan: {
                        objectives: 'Gestionar 20 proyectos I+D empresariales\nCrear incubadora de startups',
                        resources: 'Laboratorio de innovaciÃ³n\nFondo semilla para startups',
                        additionalNotes: 'Experta en transferencia tecnolÃ³gica universidad-empresa.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario04_A13',
                    name: 'Lic. Jorge RamÃ­rez Vega',
                    role: 'user',
                    adminId: 'Admin13',
                    password: 'pass123',
                    generalScore: 87,
                    generalComments: 'Especialista en responsabilidad social empresarial y sostenibilidad.',
                    badges: { excellence: false, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Implementar programa de RSE\nDesarrollar certificaciÃ³n en sostenibilidad',
                        resources: 'ConsultorÃ­a en sostenibilidad\nPlataforma de mediciÃ³n de impacto',
                        additionalNotes: 'LÃ­der en educaciÃ³n para la sostenibilidad empresarial.'
                    },
                    categories: {}
                },
                {
                    username: 'usuario05_A13',
                    name: 'Dra. Carmen JimÃ©nez Torres',
                    role: 'user',
                    adminId: 'Admin13',
                    password: 'pass123',
                    generalScore: 92,
                    generalComments: 'Investigadora en emprendimiento e innovaciÃ³n empresarial.',
                    badges: { excellence: true, communicator: true, consistent: true },
                    workPlan: {
                        objectives: 'Publicar estudio sobre emprendimiento digital\nCrear aceleradora de negocios',
                        resources: 'Centro de emprendimiento\nRed de inversionistas Ã¡ngel',
                        additionalNotes: 'Mentora de mÃ¡s de 100 emprendedores exitosos.'
                    },
                    categories: {}
                }
            ]
        };

        // Elementos del DOM
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const adminPanel = document.getElementById('adminPanel');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ===== INICIALIZACIÃ“N DE LA APLICACIÃ“N =====

        async function initializeApp() {
            try {
                updateInitProgress('Verificando Firebase...');
                await checkFirebaseConnection();
                
                updateInitProgress('Cargando configuraciÃ³n...');
                await loadConfiguration();
                
                updateInitProgress('Configurando eventos...');
                setupEventListeners();
                
                updateInitProgress('Â¡Listo!');
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Error inicializando aplicaciÃ³n:', error);
                updateInitProgress('Error de conexiÃ³n. Usando modo offline...');
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }, 2000);
            }
        }

        function updateInitProgress(message) {
            document.getElementById('initProgress').textContent = message;
        }

        async function checkFirebaseConnection() {
            try {
                const { getDoc, doc } = window.firebaseFunctions;
                const testDoc = await getDoc(doc(window.firebaseDb, 'test', 'connection'));
                isFirebaseInitialized = true;
                updateFirebaseStatus('ğŸŸ¢ Conectado', 'text-green-600');
            } catch (error) {
                console.log('Firebase no inicializado, usando datos locales');
                isFirebaseInitialized = false;
                updateFirebaseStatus('ğŸŸ¡ Modo Local', 'text-yellow-600');
            }
        }

        function updateFirebaseStatus(message, className) {
            const statusElement = document.getElementById('statusContent');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `text-sm ${className}`;
            }
        }

        async function loadConfiguration() {
            if (isFirebaseInitialized) {
                try {
                    await loadConfigFromFirebase();
                    await loadCredentialsFromFirebase();
                } catch (error) {
                    console.log('Usando configuraciÃ³n por defecto');
                    loadDefaultConfiguration();
                }
            } else {
                loadDefaultConfiguration();
            }
        }

        async function loadCredentialsFromFirebase() {
            try {
                const { getDoc, doc } = window.firebaseFunctions;
                const credentialsDoc = await getDoc(doc(window.firebaseDb, 'config', 'userCredentials'));
                if (credentialsDoc.exists()) {
                    userCredentials = { ...defaultCredentials, ...credentialsDoc.data() };
                }
            } catch (error) {
                console.log('Usando credenciales por defecto');
                userCredentials = { ...defaultCredentials };
            }
        }

        async function loadConfigFromFirebase() {
            const { getDoc, doc } = window.firebaseFunctions;
            
            // Cargar textos de login
            const loginTextsDoc = await getDoc(doc(window.firebaseDb, 'config', 'loginTexts'));
            if (loginTextsDoc.exists()) {
                const loginTexts = loginTextsDoc.data();
                updateLoginTexts(loginTexts);
            }
            
            // Cargar template de evaluaciÃ³n
            const templateDoc = await getDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'));
            if (templateDoc.exists()) {
                evaluationTemplate = templateDoc.data();
                categoriesData = evaluationTemplate.categories || [];
            }
        }

        function loadDefaultConfiguration() {
            updateLoginTexts(defaultData.loginTexts);
            evaluationTemplate = defaultData.evaluationTemplate;
            categoriesData = defaultData.evaluationTemplate.categories;
        }

        function updateLoginTexts(texts) {
            document.getElementById('loginTitle').textContent = `ğŸ“Š ${texts.mainTitle}`;
            document.getElementById('loginSubtitle').textContent = texts.subtitle;
            document.getElementById('loginDepartment').textContent = texts.department;
            document.getElementById('loginDescription').textContent = `ğŸ” ${texts.description}`;
        }

        function setupEventListeners() {
            // Manejar envÃ­o del formulario de login
            loginForm.addEventListener('submit', handleLogin);
            
            // Permitir login con Enter
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !loginScreen.classList.contains('hidden')) {
                    handleLogin(e);
                }
            });

            // Botones de navegaciÃ³n
            document.getElementById('adminLogout').addEventListener('click', logout);
            document.getElementById('backToLogin').addEventListener('click', logout);

            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Admin Panel Event Listeners
            setupAdminEventListeners();
            

        }

        function setupAdminEventListeners() {
            // Inicializar Firebase
            document.getElementById('initFirebaseBtn').addEventListener('click', initializeFirebaseData);

            // Guardar textos de login
            document.getElementById('saveLoginTexts').addEventListener('click', saveLoginTexts);

            // GestiÃ³n de usuarios
            document.getElementById('addUserBtn').addEventListener('click', () => openUserModal());
            document.getElementById('clearTableBtn').addEventListener('click', showConfirmModal);

            // Modales de usuario
            document.getElementById('closeUserModal').addEventListener('click', closeUserModal);
            document.getElementById('cancelUserModal').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', saveUser);

            // Modal de detalles
            document.getElementById('closeDetailsModal').addEventListener('click', closeDetailsModal);
            document.getElementById('cancelDetailsModal').addEventListener('click', closeDetailsModal);
            document.getElementById('userDetailsForm').addEventListener('submit', saveUserDetails);

            // Modal de confirmaciÃ³n
            document.getElementById('confirmClear').addEventListener('click', clearAllUsers);
            document.getElementById('cancelClear').addEventListener('click', closeConfirmModal);

            // Modales de categorÃ­as
            document.getElementById('editCategoriesBtn').addEventListener('click', openCategoriesModal);
            document.getElementById('closeCategoriesModal').addEventListener('click', closeCategoriesModal);
            document.getElementById('cancelCategoriesBtn').addEventListener('click', closeCategoriesModal);
            document.getElementById('addCategoryBtn').addEventListener('click', addCategoryRow);
            document.getElementById('saveCategoriesBtn').addEventListener('click', saveCategories);

            // CSV functionality
            document.getElementById('downloadCSVBtn').addEventListener('click', downloadCSVTemplate);
            document.getElementById('uploadCSVBtn').addEventListener('click', () => {
                document.getElementById('csvFileInput').click();
            });
            document.getElementById('csvFileInput').addEventListener('change', handleCSVUpload);

            // Admin management
            document.getElementById('addAdminBtn').addEventListener('click', openAddAdminModal);
            document.getElementById('manageAdminsBtn').addEventListener('click', openManageAdminsModal);
            
            // Add Admin Modal
            document.getElementById('closeAddAdminModal').addEventListener('click', closeAddAdminModal);
            document.getElementById('cancelAddAdminModal').addEventListener('click', closeAddAdminModal);
            document.getElementById('addAdminForm').addEventListener('submit', saveNewAdmin);
            
            // Manage Admins Modal
            document.getElementById('closeManageAdminsModal').addEventListener('click', closeManageAdminsModal);
            document.getElementById('closeManageAdminsBtn').addEventListener('click', closeManageAdminsModal);
            
            // Delete Admin Modal
            document.getElementById('confirmDeleteAdmin').addEventListener('click', confirmDeleteAdmin);
            document.getElementById('cancelDeleteAdmin').addEventListener('click', closeDeleteAdminModal);
        }

        // ===== INICIALIZACIÃ“N AUTOMÃTICA DE FIREBASE =====

        async function initializeFirebaseData() {
            try {
                showNotification('ğŸ”§ Inicializando Firebase...', 'info');
                
                // Crear usuarios en Authentication
                await createDefaultUsers();
                
                // Crear configuraciÃ³n en Firestore
                await createDefaultConfig();
                
                // Crear usuarios de ejemplo en Firestore
                await createDefaultUserData();
                
                isFirebaseInitialized = true;
                updateFirebaseStatus('ğŸŸ¢ Inicializado Correctamente', 'text-green-600');
                showNotification('âœ… Firebase inicializado correctamente');
                
                // Recargar datos
                await loadConfiguration();
                loadUsersTable();
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                showNotification('âŒ Error inicializando Firebase: ' + error.message, 'error');
            }
        }

        async function createDefaultUsers() {
            const { createUserWithEmailAndPassword } = window.firebaseFunctions;
            const auth = window.firebaseAuth;
            
            const usersToCreate = [
                { email: 'admin@cnci.edu.mx', password: 'admin123' },
                { email: 'usuario01@cnci.edu.mx', password: 'password123' },
                { email: 'usuario02@cnci.edu.mx', password: 'password123' }
            ];
            
            for (const user of usersToCreate) {
                try {
                    await createUserWithEmailAndPassword(auth, user.email, user.password);
                    console.log(`Usuario creado: ${user.email}`);
                } catch (error) {
                    if (error.code !== 'auth/email-already-in-use') {
                        console.error(`Error creando usuario ${user.email}:`, error);
                    }
                }
            }
        }

        async function createDefaultConfig() {
            const { setDoc, doc } = window.firebaseFunctions;
            
            // Guardar textos de login
            await setDoc(doc(window.firebaseDb, 'config', 'loginTexts'), defaultData.loginTexts);
            
            // Guardar template de evaluaciÃ³n
            await setDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'), defaultData.evaluationTemplate);
            
            // Guardar credenciales de usuarios
            await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
        }

        async function createDefaultUserData() {
            const { setDoc, doc } = window.firebaseFunctions;
            
            for (const user of defaultData.defaultUsers) {
                await setDoc(doc(window.firebaseDb, 'users', user.username), user);
            }
        }

        // ===== FUNCIONES DE LOGIN =====

        async function handleLogin(e) {
            e.preventDefault();
            
            const selectedAdmin = document.getElementById('adminSelect').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                // Verificar que se haya seleccionado un administrador
                if (!selectedAdmin) {
                    throw new Error('Debes seleccionar un administrador');
                }
                
                // Verificar credenciales localmente primero
                if (!userCredentials[username]) {
                    throw new Error('Usuario no encontrado');
                }
                
                if (userCredentials[username].password !== password) {
                    throw new Error('ContraseÃ±a incorrecta');
                }
                
                // Verificar que el usuario pertenezca al admin seleccionado (si es usuario)
                if (userCredentials[username].role === 'user') {
                    if (userCredentials[username].adminId !== selectedAdmin) {
                        throw new Error('Usuario no pertenece al administrador seleccionado');
                    }
                }
                
                // Verificar que el admin coincida (si es admin)
                if (userCredentials[username].role === 'admin') {
                    if (username !== selectedAdmin) {
                        throw new Error('El administrador no coincide con el usuario ingresado');
                    }
                }
                
                // Cargar datos del usuario
                if (userCredentials[username].role === 'admin') {
                    currentUser = {
                        username: username,
                        name: userCredentials[username].name,
                        department: userCredentials[username].department,
                        role: 'admin'
                    };
                } else {
                    await loadUserFromStorage(username);
                }
                
                loginError.classList.add('hidden');
                
                if (currentUser.role === 'admin') {
                    showAdminPanel();
                } else {
                    showDashboard();
                }
                
            } catch (error) {
                console.error('Error en login:', error);
                loginError.textContent = `âŒ ${error.message}`;
                loginError.classList.remove('hidden');
            }
        }

        async function loadUserFromStorage(username) {
            try {
                if (isFirebaseInitialized) {
                    // Intentar cargar desde Firestore
                    const { getDoc, doc } = window.firebaseFunctions;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', username));
                    if (userDoc.exists()) {
                        currentUser = userDoc.data();
                        return;
                    }
                }
                
                // Fallback a datos locales
                const userData = defaultData.defaultUsers.find(u => u.username === username);
                if (userData) {
                    currentUser = userData;
                } else {
                    throw new Error('Datos de usuario no encontrados');
                }
            } catch (error) {
                console.error('Error cargando usuario:', error);
                throw new Error('Error cargando datos del usuario');
            }
        }



        // ===== FUNCIONES DE NAVEGACIÃ“N =====

        function showAdminPanel() {
            loginScreen.classList.add('hidden');
            dashboard.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            
            loadAdminData();
        }

        function showDashboard() {
            loginScreen.classList.add('hidden');
            adminPanel.classList.add('hidden');
            dashboard.classList.remove('hidden');
            
            loadUserData();
        }

        function logout() {
            if (isFirebaseInitialized) {
                const { signOut } = window.firebaseFunctions;
                signOut(window.firebaseAuth);
            }
            
            currentUser = null;
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            dashboard.classList.add('hidden');
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loginError.classList.add('hidden');
        }

        // ===== FUNCIONES DEL DASHBOARD =====

        function calculateGeneralScore(categories) {
            if (!categories || Object.keys(categories).length === 0) return 0;
            
            const scores = Object.values(categories).map(category => category.score || 0);
            const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            return Math.round(average * 10) / 10; // Redondear a 1 decimal
        }

        function calculateCategoryScore(criteria) {
            if (!criteria || criteria.length === 0) return 0;
            
            const scores = criteria.map(criterion => {
                if (typeof criterion === 'object' && criterion.score !== undefined) {
                    return criterion.score;
                }
                return 0;
            });
            
            const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            return Math.round(average * 10) / 10; // Redondear a 1 decimal
        }

        function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            // Calcular puntaje general como promedio de todas las categorÃ­as
            const generalScore = calculateGeneralScore(currentUser.categories);
            document.getElementById('generalScore').textContent = generalScore + '/10';
            document.getElementById('generalComments').textContent = currentUser.generalComments;
            
            loadEvaluationCategories();
            loadUserBadges();
            loadUserWorkPlan();
        }

        function loadEvaluationCategories() {
            const container = document.getElementById('evaluationCategories');
            container.innerHTML = '';
            
            if (!currentUser.categories) return;
            
            Object.entries(currentUser.categories).forEach(([categoryName, categoryData]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white border border-gray-200 rounded-xl p-6 card-shadow slide-in';
                
                // Crear lista de criterios con calificaciones individuales
                const criteriaList = categoryData.criteria.map(criteria => {
                    if (typeof criteria === 'object' && criteria.name && criteria.score !== undefined) {
                        return `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded-lg mb-2">
                            <span class="text-gray-700 text-sm">${criteria.name}</span>
                            <span class="font-semibold text-[#2a6aff] text-sm">${criteria.score}/10</span>
                        </div>`;
                    } else {
                        // Compatibilidad con formato anterior
                        return `<span class="inline-block bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm mr-2 mb-2">${criteria}</span>`;
                    }
                }).join('');
                
                // Calcular porcentaje para la barra de progreso (score/10 * 100)
                const progressPercentage = (categoryData.score / 10) * 100;
                
                categoryCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="text-lg font-semibold text-gray-800">${categoryName}</h4>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-[#2a6aff]">${categoryData.score}</div>
                            <div class="text-sm text-gray-500">/10</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="bg-gray-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-[#2a6aff] to-[#ff8500] h-3 rounded-full transition-all duration-500" 
                                 style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 text-center">${progressPercentage.toFixed(1)}%</div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600 font-medium">Criterios evaluados:</p>
                        <div class="space-y-1">${criteriaList}</div>
                    </div>
                `;
                
                container.appendChild(categoryCard);
            });
        }

        function loadUserBadges() {
            const badgesContainer = document.getElementById('userBadges');
            badgesContainer.innerHTML = '';
            
            if (!currentUser.badges) return;
            
            const badges = [
                { key: 'excellence', name: 'Excelencia', emoji: 'ğŸ¥‡', description: 'CalificaciÃ³n superior a 90', bgColor: 'bg-yellow-50', borderColor: 'border-yellow-200', textColor: 'text-yellow-800' },
                { key: 'communicator', name: 'Comunicador', emoji: 'ğŸ“', description: 'Excelente en llamadas', bgColor: 'bg-blue-50', borderColor: 'border-blue-200', textColor: 'text-blue-800' },
                { key: 'consistent', name: 'Consistente', emoji: 'â­', description: 'DesempeÃ±o estable', bgColor: 'bg-green-50', borderColor: 'border-green-200', textColor: 'text-green-800' }
            ];
            
            badges.forEach(badge => {
                if (currentUser.badges[badge.key]) {
                    const badgeElement = document.createElement('div');
                    badgeElement.className = `${badge.bgColor} border-2 ${badge.borderColor} p-6 rounded-xl text-center transform hover:scale-105 transition-all`;
                    badgeElement.innerHTML = `
                        <div class="text-4xl mb-3">${badge.emoji}</div>
                        <h4 class="font-semibold ${badge.textColor}">${badge.name}</h4>
                        <p class="text-sm ${badge.textColor.replace('800', '600')} mt-2">${badge.description}</p>
                        <div class="mt-3 text-xs ${badge.textColor} font-medium">âœ… OBTENIDA</div>
                    `;
                    badgesContainer.appendChild(badgeElement);
                }
            });
            
            if (badgesContainer.children.length === 0) {
                badgesContainer.innerHTML = `
                    <div class="col-span-3 text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">ğŸ¯</div>
                        <p>Â¡Sigue trabajando para obtener tus primeras insignias!</p>
                    </div>
                `;
            }
        }

        function loadUserWorkPlan() {
            const objectivesDisplay = document.getElementById('userObjectivesDisplay');
            const resourcesDisplay = document.getElementById('userResourcesDisplay');
            const notesDisplay = document.getElementById('userAdditionalNotesDisplay');
            const notesSection = document.getElementById('additionalNotesSection');
            
            if (currentUser.workPlan) {
                objectivesDisplay.textContent = currentUser.workPlan.objectives || 'No hay objetivos especÃ­ficos definidos aÃºn.';
                resourcesDisplay.textContent = currentUser.workPlan.resources || 'No hay recursos recomendados especÃ­ficos aÃºn.';
                
                if (currentUser.workPlan.additionalNotes && currentUser.workPlan.additionalNotes.trim()) {
                    notesDisplay.textContent = currentUser.workPlan.additionalNotes;
                    notesSection.classList.remove('hidden');
                } else {
                    notesSection.classList.add('hidden');
                }
            } else {
                objectivesDisplay.textContent = 'Plan de trabajo personalizado en desarrollo...';
                resourcesDisplay.textContent = 'Recursos serÃ¡n asignados segÃºn tu desempeÃ±o...';
                notesSection.classList.add('hidden');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
                button.classList.add('text-gray-600');
            });
            
            document.getElementById(tabName).classList.remove('hidden');
            
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            activeButton.classList.add('tab-active');
            activeButton.classList.remove('text-gray-600');
        }

        // ===== FUNCIONES DEL PANEL DE ADMINISTRADOR =====

        async function loadAdminData() {
            // Mostrar informaciÃ³n del administrador actual
            const adminInfo = document.getElementById('currentAdminInfo');
            if (currentUser && currentUser.role === 'admin') {
                adminInfo.textContent = `${currentUser.name} (${currentUser.username}) - ${currentUser.department}`;
            }
            
            await loadUsersTable();
            loadLoginTextsToForm();
        }

        function loadLoginTextsToForm() {
            if (isFirebaseInitialized) {
                // Los datos ya se cargaron en loadConfiguration
                const loginTexts = {
                    mainTitle: document.getElementById('loginTitle').textContent.replace('ğŸ“Š ', ''),
                    subtitle: document.getElementById('loginSubtitle').textContent,
                    department: document.getElementById('loginDepartment').textContent,
                    description: document.getElementById('loginDescription').textContent.replace('ğŸ” ', '')
                };
                
                document.getElementById('mainTitle').value = loginTexts.mainTitle;
                document.getElementById('subtitle').value = loginTexts.subtitle;
                document.getElementById('department').value = loginTexts.department;
                document.getElementById('description').value = loginTexts.description;
            } else {
                // Usar datos por defecto
                document.getElementById('mainTitle').value = defaultData.loginTexts.mainTitle;
                document.getElementById('subtitle').value = defaultData.loginTexts.subtitle;
                document.getElementById('department').value = defaultData.loginTexts.department;
                document.getElementById('description').value = defaultData.loginTexts.description;
            }
        }

        async function saveLoginTexts() {
            const loginTexts = {
                mainTitle: document.getElementById('mainTitle').value,
                subtitle: document.getElementById('subtitle').value,
                department: document.getElementById('department').value,
                description: document.getElementById('description').value
            };

            try {
                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    await setDoc(doc(window.firebaseDb, 'config', 'loginTexts'), loginTexts);
                }
                
                // Actualizar la interfaz inmediatamente
                updateLoginTexts(loginTexts);
                showNotification('âœ… Textos de login actualizados correctamente');
            } catch (error) {
                console.error('Error guardando textos:', error);
                showNotification('âŒ Error al guardar los textos', 'error');
            }
        }

        async function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            try {
                if (isFirebaseInitialized) {
                    // Cargar desde Firestore solo usuarios del admin actual
                    const { getDocs, collection, query, where } = window.firebaseFunctions;
                    const usersQuery = query(
                        collection(window.firebaseDb, 'users'), 
                        where('role', '==', 'user'),
                        where('adminId', '==', currentUser.username)
                    );
                    const querySnapshot = await getDocs(usersQuery);
                    
                    allUsers = [];
                    querySnapshot.forEach((doc) => {
                        allUsers.push(doc.data());
                    });
                } else {
                    // Usar datos por defecto filtrados por admin
                    allUsers = defaultData.defaultUsers.filter(user => 
                        user.adminId === currentUser.username
                    );
                }

                allUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    
                    const shortComments = user.generalComments ? 
                        (user.generalComments.length > 50 ? user.generalComments.substring(0, 50) + '...' : user.generalComments) : 
                        'Sin comentarios';

                    // Obtener la contraseÃ±a actual del usuario
                    const currentPassword = userCredentials[user.username]?.password || user.password || 'password123';

                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${user.username || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${user.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <span class="bg-gray-100 px-2 py-1 rounded font-mono text-xs">${currentPassword}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${calculateGeneralScore(user.categories)}/10</td>
                        <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">${shortComments}</td>
                        <td class="px-4 py-3 text-sm space-x-2">
                            <button onclick="editUser('${user.username}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-all">
                                âœï¸ Editar
                            </button>
                            <button onclick="showUserDetails('${user.username}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition-all">
                                ğŸ“Š Detalles
                            </button>
                            <button onclick="deleteUser('${user.username}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-all">
                                ğŸ—‘ï¸ Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showNotification('âŒ Error cargando usuarios', 'error');
            }
        }

        // ===== GESTIÃ“N DE USUARIOS =====

        function openUserModal(username = null) {
            currentEditingUser = username;
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            
            if (username) {
                title.textContent = 'âœï¸ Editar Usuario';
                const user = allUsers.find(u => u.username === username);
                if (user) {
                    document.getElementById('userId').value = user.username || '';
                    document.getElementById('userNameInput').value = user.name || '';
                    document.getElementById('userGeneralScore').value = user.generalScore || 0;
                    document.getElementById('userComments').value = user.generalComments || '';
                    // Mostrar contraseÃ±a actual como placeholder
                    const currentPassword = userCredentials[username]?.password || user.password || 'password123';
                    document.getElementById('userPassword').placeholder = `Actual: ${currentPassword}`;
                }
            } else {
                title.textContent = 'â• AÃ±adir Usuario';
                document.getElementById('userForm').reset();
                document.getElementById('userPassword').placeholder = 'ContraseÃ±a para el nuevo usuario';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeUserModal() {
            const modal = document.getElementById('userModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditingUser = null;
        }

        async function saveUser(e) {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('userId').value,
                name: document.getElementById('userNameInput').value,
                role: 'user',
                adminId: currentUser.username, // Asignar al admin actual
                generalComments: document.getElementById('userComments').value,
                categories: getDefaultCategories(),
                badges: {
                    excellence: false,
                    communicator: false,
                    consistent: false
                },
                workPlan: {
                    objectives: '',
                    resources: '',
                    additionalNotes: ''
                }
            };

            const newPassword = document.getElementById('userPassword').value;

            try {
                // Actualizar contraseÃ±a en el sistema local
                if (newPassword && newPassword.trim() !== '') {
                    userCredentials[userData.username] = {
                        password: newPassword,
                        role: 'user',
                        adminId: currentUser.username
                    };
                    userData.password = newPassword;
                } else if (!userCredentials[userData.username]) {
                    // Usuario nuevo sin contraseÃ±a especificada
                    userCredentials[userData.username] = {
                        password: 'pass123',
                        role: 'user',
                        adminId: currentUser.username
                    };
                    userData.password = 'pass123';
                } else {
                    // Mantener contraseÃ±a existente
                    userData.password = userCredentials[userData.username].password;
                }

                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    
                    // Si es un usuario existente, preservar datos adicionales
                    if (currentEditingUser) {
                        const existingUser = allUsers.find(u => u.username === currentEditingUser);
                        if (existingUser) {
                            userData.badges = existingUser.badges || userData.badges;
                            userData.workPlan = existingUser.workPlan || userData.workPlan;
                            userData.categories = existingUser.categories || userData.categories;
                        }
                    }
                    
                    await setDoc(doc(window.firebaseDb, 'users', userData.username), userData);
                    
                    // Guardar credenciales en Firebase
                    await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
                    
                    // Sincronizar categorÃ­as con el template actual
                    await updateUserCategoriesFromTemplate(userData.username);
                } else {
                    // Modo local
                    if (currentEditingUser) {
                        const existingUserIndex = allUsers.findIndex(u => u.username === currentEditingUser);
                        if (existingUserIndex !== -1) {
                            // Preservar datos adicionales en modo local
                            userData.badges = allUsers[existingUserIndex].badges || userData.badges;
                            userData.workPlan = allUsers[existingUserIndex].workPlan || userData.workPlan;
                            userData.categories = syncUserCategories(allUsers[existingUserIndex].categories || {}, categoriesData);
                            allUsers[existingUserIndex] = userData;
                        }
                    } else {
                        userData.categories = syncUserCategories({}, categoriesData);
                        allUsers.push(userData);
                    }
                }
                
                closeUserModal();
                await loadUsersTable();
                showNotification('âœ… Usuario y contraseÃ±a guardados correctamente');
            } catch (error) {
                console.error('Error guardando usuario:', error);
                showNotification('âŒ Error al guardar el usuario', 'error');
            }
        }

        function getDefaultCategories() {
            const categories = {};
            categoriesData.forEach(category => {
                categories[category.name] = {
                    score: 0,
                    criteria: [...category.criteria]
                };
            });
            return categories;
        }

        // FunciÃ³n para actualizar categorÃ­as cuando se crea un nuevo usuario
        async function updateUserCategoriesFromTemplate(username) {
            if (!isFirebaseInitialized) return;
            
            try {
                const { getDoc, doc, updateDoc } = window.firebaseFunctions;
                
                // Obtener el template actual
                const templateDoc = await getDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'));
                if (!templateDoc.exists()) return;
                
                const currentTemplate = templateDoc.data();
                const userDoc = await getDoc(doc(window.firebaseDb, 'users', username));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const syncedCategories = syncUserCategories(userData.categories || {}, currentTemplate.categories);
                    
                    await updateDoc(doc(window.firebaseDb, 'users', username), {
                        categories: syncedCategories
                    });
                }
            } catch (error) {
                console.error('Error actualizando categorÃ­as del usuario:', error);
            }
        }

        function editUser(username) {
            openUserModal(username);
        }

        async function deleteUser(username) {
            if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar este usuario?')) {
                try {
                    if (isFirebaseInitialized) {
                        const { deleteDoc, doc } = window.firebaseFunctions;
                        await deleteDoc(doc(window.firebaseDb, 'users', username));
                    }
                    
                    await loadUsersTable();
                    showNotification('âœ… Usuario eliminado correctamente');
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    showNotification('âŒ Error al eliminar el usuario', 'error');
                }
            }
        }

        // ===== MODAL DE DETALLES =====

        function updateCategoryScore(categoryName) {
            // Obtener todas las calificaciones de criterios para esta categorÃ­a
            const criteriaScores = document.querySelectorAll(`[data-category="${categoryName}"].criteria-score`);
            const scores = Array.from(criteriaScores).map(input => parseFloat(input.value) || 0);
            
            // Calcular promedio
            const average = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
            const roundedAverage = Math.round(average * 10) / 10;
            
            // Actualizar display del puntaje de categorÃ­a
            const scoreDisplay = document.querySelector(`[data-category="${categoryName}"].category-score-display`);
            if (scoreDisplay) {
                scoreDisplay.textContent = roundedAverage;
            }
            
            // Actualizar puntaje general
            updateGeneralScore();
        }

        function updateGeneralScore() {
            const categoryScores = document.querySelectorAll('.category-score-display');
            const scores = Array.from(categoryScores).map(display => parseFloat(display.textContent) || 0);
            
            if (scores.length > 0) {
                const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                const roundedAverage = Math.round(average * 10) / 10;
                
                const generalScoreInput = document.getElementById('detailsGeneralScore');
                if (generalScoreInput) {
                    generalScoreInput.value = roundedAverage + '/10';
                }
            }
        }

        function showUserDetails(username) {
            const user = allUsers.find(u => u.username === username);
            if (!user) return;

            document.getElementById('detailsUserId').value = user.username || '';
            document.getElementById('detailsUserName').value = user.name || '';
            document.getElementById('detailsUserRole').value = user.role || 'user';
            document.getElementById('detailsGeneralScore').value = calculateGeneralScore(user.categories) + '/10';
            document.getElementById('detailsGeneralComments').value = user.generalComments || '';
            document.getElementById('detailsUserPassword').value = ''; // Siempre vacÃ­o por seguridad

            // Cargar insignias
            document.getElementById('badgeExcellence').checked = user.badges?.excellence || false;
            document.getElementById('badgeCommunicator').checked = user.badges?.communicator || false;
            document.getElementById('badgeConsistent').checked = user.badges?.consistent || false;

            // Cargar plan de trabajo
            document.getElementById('userObjectives').value = user.workPlan?.objectives || '';
            document.getElementById('userResources').value = user.workPlan?.resources || '';
            document.getElementById('userAdditionalNotes').value = user.workPlan?.additionalNotes || '';

            loadUserCategories(user);

            currentEditingUser = username;
            const modal = document.getElementById('userDetailsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function loadUserCategories(user) {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            if (user.categories) {
                Object.entries(user.categories).forEach(([categoryName, categoryData]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-gray-50 p-4 rounded-lg';
                    
                    // Crear inputs para criterios con calificaciones individuales
                    const criteriaInputs = categoryData.criteria.map((criteria, index) => {
                        let criteriaName = '';
                        let criteriaScore = 0;
                        
                        if (typeof criteria === 'object' && criteria.name && criteria.score !== undefined) {
                            criteriaName = criteria.name;
                            criteriaScore = criteria.score;
                        } else {
                            // Compatibilidad con formato anterior
                            criteriaName = criteria;
                            criteriaScore = 0;
                        }
                        
                        return `
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="text" value="${criteriaName}" 
                                       class="criteria-name flex-1 px-3 py-1 border border-gray-300 rounded text-sm" 
                                       data-category="${categoryName}" data-index="${index}">
                                <input type="number" value="${criteriaScore}" min="0" max="10" step="0.1"
                                       class="criteria-score w-20 px-2 py-1 border border-gray-300 rounded text-sm text-center" 
                                       data-category="${categoryName}" data-index="${index}"
                                       onchange="updateCategoryScore('${categoryName}')">
                                <span class="text-xs text-gray-500">/10</span>
                            </div>
                        `;
                    }).join('');

                    categoryDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-gray-800">${categoryName}</h5>
                            <div class="text-right">
                                <span class="category-score-display text-lg font-bold text-[#2a6aff]" data-category="${categoryName}">${categoryData.score}</span>
                                <span class="text-sm text-gray-500">/10</span>
                                <div class="text-xs text-gray-400">(Promedio automÃ¡tico)</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Criterios y Calificaciones:</label>
                            ${criteriaInputs}
                        </div>
                    `;
                    
                    container.appendChild(categoryDiv);
                });
            }
        }

        function closeDetailsModal() {
            const modal = document.getElementById('userDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditingUser = null;
        }

        async function saveUserDetails(e) {
            e.preventDefault();
            
            if (!currentEditingUser) return;

            const userData = {
                username: document.getElementById('detailsUserId').value,
                name: document.getElementById('detailsUserName').value,
                role: document.getElementById('detailsUserRole').value,
                generalComments: document.getElementById('detailsGeneralComments').value,
                categories: {},
                badges: {
                    excellence: document.getElementById('badgeExcellence').checked,
                    communicator: document.getElementById('badgeCommunicator').checked,
                    consistent: document.getElementById('badgeConsistent').checked
                },
                workPlan: {
                    objectives: document.getElementById('userObjectives').value,
                    resources: document.getElementById('userResources').value,
                    additionalNotes: document.getElementById('userAdditionalNotes').value
                }
            };

            const newPassword = document.getElementById('detailsUserPassword').value;

            // Actualizar contraseÃ±a si se proporcionÃ³ una nueva
            if (newPassword && newPassword.trim() !== '') {
                userCredentials[currentEditingUser] = {
                    password: newPassword,
                    role: userData.role
                };
                userData.password = newPassword;
            } else {
                // Mantener contraseÃ±a existente
                userData.password = userCredentials[currentEditingUser]?.password || 'password123';
            }

            // Recopilar datos de categorÃ­as con criterios y calificaciones
            const categoryNames = [...new Set(Array.from(document.querySelectorAll('[data-category]')).map(el => el.dataset.category))];
            
            categoryNames.forEach(categoryName => {
                const criteriaNames = document.querySelectorAll(`[data-category="${categoryName}"].criteria-name`);
                const criteriaScores = document.querySelectorAll(`[data-category="${categoryName}"].criteria-score`);
                
                const criteria = Array.from(criteriaNames).map((nameInput, index) => ({
                    name: nameInput.value,
                    score: parseFloat(criteriaScores[index]?.value) || 0
                }));
                
                // Calcular el puntaje de la categorÃ­a como promedio de criterios
                const categoryScore = calculateCategoryScore(criteria);
                
                userData.categories[categoryName] = { 
                    score: categoryScore, 
                    criteria: criteria 
                };
            });

            try {
                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    await setDoc(doc(window.firebaseDb, 'users', currentEditingUser), userData);
                    
                    // Guardar credenciales actualizadas en Firebase
                    await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
                } else {
                    // Actualizar en modo local
                    const userIndex = allUsers.findIndex(u => u.username === currentEditingUser);
                    if (userIndex !== -1) {
                        allUsers[userIndex] = userData;
                    }
                }
                
                closeDetailsModal();
                await loadUsersTable();
                showNotification('âœ… Usuario y contraseÃ±a actualizados correctamente');
            } catch (error) {
                console.error('Error actualizando usuario:', error);
                showNotification('âŒ Error al actualizar el usuario', 'error');
            }
        }

        // ===== VACIAR TABLA =====

        function showConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function clearAllUsers() {
            try {
                if (isFirebaseInitialized) {
                    const { deleteDoc, doc } = window.firebaseFunctions;
                    for (const user of allUsers) {
                        await deleteDoc(doc(window.firebaseDb, 'users', user.username));
                    }
                }
                
                closeConfirmModal();
                await loadUsersTable();
                showNotification('âœ… Todos los usuarios han sido eliminados');
            } catch (error) {
                console.error('Error vaciando tabla:', error);
                showNotification('âŒ Error al vaciar la tabla', 'error');
            }
        }

        // ===== GESTIÃ“N DE CATEGORÃAS =====

        function openCategoriesModal() {
            loadCategoriesEditContainer();
            const modal = document.getElementById('categoriesModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeCategoriesModal() {
            const modal = document.getElementById('categoriesModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function loadCategoriesEditContainer() {
            const container = document.getElementById('categoriesEditContainer');
            container.innerHTML = '';

            categoriesData.forEach((category, index) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-gray-50 p-4 rounded-lg';
                
                const criteriaInputs = category.criteria.map((criteria, criteriaIndex) => 
                    `<div class="flex items-center space-x-2 mb-2">
                        <input type="text" value="${criteria}" class="flex-1 px-3 py-1 border border-gray-300 rounded text-sm" data-category="${index}" data-criteria="${criteriaIndex}">
                        <button type="button" onclick="removeCriteria(${index}, ${criteriaIndex})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                            ğŸ—‘ï¸
                        </button>
                    </div>`
                ).join('');

                categoryDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <input type="text" value="${category.name}" class="font-semibold text-lg border-b-2 border-transparent hover:border-gray-300 focus:border-[#2a6aff] outline-none" data-category-name="${index}">
                        <button type="button" onclick="removeCategory(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            ğŸ—‘ï¸ Eliminar CategorÃ­a
                        </button>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Criterios:</label>
                        ${criteriaInputs}
                        <button type="button" onclick="addCriteria(${index})" class="bg-[#ff8500] hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                            â• AÃ±adir Criterio
                        </button>
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }

        function addCategoryRow() {
            categoriesData.push({
                name: 'Nueva CategorÃ­a',
                criteria: ['Nuevo Criterio']
            });
            loadCategoriesEditContainer();
        }

        function removeCategory(index) {
            if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar esta categorÃ­a?')) {
                categoriesData.splice(index, 1);
                loadCategoriesEditContainer();
            }
        }

        function addCriteria(categoryIndex) {
            categoriesData[categoryIndex].criteria.push('Nuevo Criterio');
            loadCategoriesEditContainer();
        }

        function removeCriteria(categoryIndex, criteriaIndex) {
            if (categoriesData[categoryIndex].criteria.length > 1) {
                categoriesData[categoryIndex].criteria.splice(criteriaIndex, 1);
                loadCategoriesEditContainer();
            } else {
                alert('Una categorÃ­a debe tener al menos un criterio');
            }
        }

        async function saveCategories() {
            const updatedCategories = [];
            
            document.querySelectorAll('[data-category-name]').forEach((input, index) => {
                const categoryName = input.value;
                const criteria = [];
                
                document.querySelectorAll(`[data-category="${index}"][data-criteria]`).forEach(criteriaInput => {
                    criteria.push(criteriaInput.value);
                });
                
                updatedCategories.push({ name: categoryName, criteria });
            });

            try {
                showNotification('ğŸ”„ Actualizando categorÃ­as y sincronizando usuarios...', 'info');
                
                if (isFirebaseInitialized) {
                    const { setDoc, doc, getDocs, collection, query, where, updateDoc } = window.firebaseFunctions;
                    
                    // 1. Guardar el nuevo template de categorÃ­as
                    await setDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'), {
                        categories: updatedCategories
                    });
                    
                    // 2. Obtener todos los usuarios existentes
                    const usersQuery = query(collection(window.firebaseDb, 'users'), where('role', '==', 'user'));
                    const querySnapshot = await getDocs(usersQuery);
                    
                    // 3. Actualizar cada usuario con las nuevas categorÃ­as
                    const updatePromises = [];
                    querySnapshot.forEach((userDoc) => {
                        const userData = userDoc.data();
                        const updatedUserCategories = syncUserCategories(userData.categories || {}, updatedCategories);
                        
                        updatePromises.push(
                            updateDoc(doc(window.firebaseDb, 'users', userData.username), {
                                categories: updatedUserCategories
                            })
                        );
                    });
                    
                    // Ejecutar todas las actualizaciones en paralelo
                    await Promise.all(updatePromises);
                    
                    showNotification(`âœ… CategorÃ­as actualizadas y sincronizadas con ${updatePromises.length} usuarios`);
                } else {
                    // Modo local - actualizar usuarios en memoria
                    allUsers.forEach(user => {
                        user.categories = syncUserCategories(user.categories || {}, updatedCategories);
                    });
                    
                    showNotification('âœ… CategorÃ­as actualizadas localmente');
                }
                
                categoriesData = [...updatedCategories];
                evaluationTemplate = { categories: updatedCategories };
                
                closeCategoriesModal();
                await loadUsersTable(); // Recargar la tabla para mostrar cambios
                
            } catch (error) {
                console.error('Error guardando categorÃ­as:', error);
                showNotification('âŒ Error al guardar las categorÃ­as', 'error');
            }
        }

        // FunciÃ³n para sincronizar categorÃ­as de usuario con el template actualizado
        function syncUserCategories(userCategories, newCategoriesTemplate) {
            const syncedCategories = {};
            
            newCategoriesTemplate.forEach(templateCategory => {
                const existingCategory = userCategories[templateCategory.name];
                
                if (existingCategory) {
                    // La categorÃ­a existe - mantener el puntaje pero actualizar criterios
                    syncedCategories[templateCategory.name] = {
                        score: existingCategory.score || 0,
                        criteria: [...templateCategory.criteria] // Usar los nuevos criterios del template
                    };
                } else {
                    // Nueva categorÃ­a - crear con puntaje 0
                    syncedCategories[templateCategory.name] = {
                        score: 0,
                        criteria: [...templateCategory.criteria]
                    };
                }
            });
            
            return syncedCategories;
        }

        // ===== FUNCIONES CSV =====

        function downloadCSVTemplate() {
            try {
                showNotification('ğŸ“¥ Generando plantilla CSV...', 'info');
                
                // Crear headers del CSV
                const headers = [
                    'username',
                    'name', 
                    'password',
                    'role',
                    'generalComments',
                    'badgeExcellence',
                    'badgeCommunicator', 
                    'badgeConsistent',
                    'workPlanObjectives',
                    'workPlanResources',
                    'workPlanAdditionalNotes'
                ];

                // AÃ±adir headers para cada categorÃ­a y sus criterios
                categoriesData.forEach(category => {
                    headers.push(`category_${category.name}_score`);
                    category.criteria.forEach((criteria, index) => {
                        headers.push(`category_${category.name}_criteria_${index + 1}_name`);
                        headers.push(`category_${category.name}_criteria_${index + 1}_score`);
                    });
                });

                // Crear filas de datos
                const rows = [headers];
                
                allUsers.forEach(user => {
                    const row = [
                        user.username || '',
                        user.name || '',
                        userCredentials[user.username]?.password || user.password || 'password123',
                        user.role || 'user',
                        user.generalComments || '',
                        user.badges?.excellence ? 'true' : 'false',
                        user.badges?.communicator ? 'true' : 'false',
                        user.badges?.consistent ? 'true' : 'false',
                        user.workPlan?.objectives || '',
                        user.workPlan?.resources || '',
                        user.workPlan?.additionalNotes || ''
                    ];

                    // AÃ±adir datos de categorÃ­as
                    categoriesData.forEach(category => {
                        const userCategory = user.categories?.[category.name];
                        row.push(userCategory?.score || 0);
                        
                        category.criteria.forEach((templateCriteria, index) => {
                            const userCriteria = userCategory?.criteria?.[index];
                            if (typeof userCriteria === 'object' && userCriteria.name && userCriteria.score !== undefined) {
                                row.push(userCriteria.name);
                                row.push(userCriteria.score);
                            } else {
                                // Compatibilidad con formato anterior
                                row.push(templateCriteria);
                                row.push(0);
                            }
                        });
                    });

                    rows.push(row);
                });

                // Convertir a CSV con codificaciÃ³n UTF-8
                const csvContent = rows.map(row => 
                    row.map(field => {
                        // Escapar comillas y envolver en comillas si contiene comas, saltos de lÃ­nea o comillas
                        const stringField = String(field);
                        if (stringField.includes(',') || stringField.includes('\n') || stringField.includes('"')) {
                            return '"' + stringField.replace(/"/g, '""') + '"';
                        }
                        return stringField;
                    }).join(',')
                ).join('\n');

                // AÃ±adir BOM para UTF-8 para mejor compatibilidad con Excel
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;

                // Descargar archivo
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `plantilla_evaluacion_cnci_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification('âœ… Plantilla CSV descargada correctamente');
                
            } catch (error) {
                console.error('Error generando CSV:', error);
                showNotification('âŒ Error al generar la plantilla CSV', 'error');
            }
        }

        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('âŒ Por favor selecciona un archivo CSV vÃ¡lido', 'error');
                return;
            }

            try {
                showNotification('ğŸ“¤ Procesando archivo CSV...', 'info');
                
                const text = await readFileAsText(file);
                const rows = parseCSV(text);
                
                if (rows.length < 2) {
                    showNotification('âŒ El archivo CSV debe contener al menos una fila de datos', 'error');
                    return;
                }

                const headers = rows[0];
                const dataRows = rows.slice(1);
                
                // Validar headers bÃ¡sicos
                const requiredHeaders = ['username', 'name', 'password'];
                const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
                
                if (missingHeaders.length > 0) {
                    showNotification(`âŒ Faltan columnas requeridas: ${missingHeaders.join(', ')}`, 'error');
                    return;
                }

                let processedUsers = 0;
                let errors = [];

                for (const row of dataRows) {
                    try {
                        if (row.length !== headers.length) {
                            errors.push(`Fila con nÃºmero incorrecto de columnas: ${row.join(',').substring(0, 50)}...`);
                            continue;
                        }

                        const userData = {};
                        headers.forEach((header, index) => {
                            userData[header] = row[index];
                        });

                        // Validar datos bÃ¡sicos
                        if (!userData.username || !userData.name) {
                            errors.push(`Usuario sin nombre o username: ${userData.username || 'N/A'}`);
                            continue;
                        }

                        // Procesar usuario
                        await processUserFromCSV(userData, headers);
                        processedUsers++;
                        
                    } catch (error) {
                        errors.push(`Error procesando usuario ${row[0] || 'desconocido'}: ${error.message}`);
                    }
                }

                // Recargar tabla y mostrar resultados
                await loadUsersTable();
                
                if (errors.length > 0) {
                    console.warn('Errores durante la carga:', errors);
                    showNotification(`âš ï¸ ${processedUsers} usuarios procesados. ${errors.length} errores encontrados (ver consola)`, 'info');
                } else {
                    showNotification(`âœ… ${processedUsers} usuarios cargados correctamente desde CSV`);
                }

            } catch (error) {
                console.error('Error procesando CSV:', error);
                showNotification('âŒ Error al procesar el archivo CSV', 'error');
            } finally {
                // Limpiar input file
                event.target.value = '';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Error leyendo archivo'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // Comilla escapada
                            current += '"';
                            i++; // Saltar la siguiente comilla
                        } else {
                            // Cambiar estado de comillas
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // Separador de campo
                        row.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // AÃ±adir Ãºltimo campo
                row.push(current);
                rows.push(row);
            }
            
            return rows;
        }

        async function processUserFromCSV(userData, headers) {
            const user = {
                username: userData.username.trim(),
                name: userData.name.trim(),
                role: userData.role || 'user',
                password: userData.password || 'password123',
                generalComments: userData.generalComments || '',
                badges: {
                    excellence: userData.badgeExcellence === 'true',
                    communicator: userData.badgeCommunicator === 'true',
                    consistent: userData.badgeConsistent === 'true'
                },
                workPlan: {
                    objectives: userData.workPlanObjectives || '',
                    resources: userData.workPlanResources || '',
                    additionalNotes: userData.workPlanAdditionalNotes || ''
                },
                categories: {}
            };

            // Procesar categorÃ­as desde CSV
            categoriesData.forEach(category => {
                const categoryScoreKey = `category_${category.name}_score`;
                const categoryScore = parseFloat(userData[categoryScoreKey]) || 0;
                
                const criteria = [];
                category.criteria.forEach((templateCriteria, index) => {
                    const criteriaNameKey = `category_${category.name}_criteria_${index + 1}_name`;
                    const criteriaScoreKey = `category_${category.name}_criteria_${index + 1}_score`;
                    
                    criteria.push({
                        name: userData[criteriaNameKey] || templateCriteria,
                        score: parseFloat(userData[criteriaScoreKey]) || 0
                    });
                });

                user.categories[category.name] = {
                    score: categoryScore,
                    criteria: criteria
                };
            });

            // Actualizar credenciales
            userCredentials[user.username] = {
                password: user.password,
                role: user.role
            };

            // Guardar usuario
            if (isFirebaseInitialized) {
                const { setDoc, doc } = window.firebaseFunctions;
                await setDoc(doc(window.firebaseDb, 'users', user.username), user);
                await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
            } else {
                // Modo local
                const existingUserIndex = allUsers.findIndex(u => u.username === user.username);
                if (existingUserIndex !== -1) {
                    allUsers[existingUserIndex] = user;
                } else {
                    allUsers.push(user);
                }
            }
        }

        // ===== GENERACIÃ“N DE REPORTE =====

        async function generateAndDownloadReport() {
            try {
                showNotification('ğŸ“„ Generando reporte...', 'info');
                
                const currentScreen = getCurrentVisibleScreen();
                await ensureDataLoaded();
                showLoginScreen();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const htmlContent = document.documentElement.outerHTML;
                restoreScreen(currentScreen);
                downloadHTMLFile(htmlContent, 'reporte_evaluacion_cnci.html');
                
                showNotification('âœ… Reporte descargado correctamente');
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                showNotification('âŒ Error al generar el reporte', 'error');
            }
        }

        function getCurrentVisibleScreen() {
            if (!loginScreen.classList.contains('hidden')) return 'login';
            if (!adminPanel.classList.contains('hidden')) return 'admin';
            if (!dashboard.classList.contains('hidden')) return 'dashboard';
            return 'login';
        }

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            dashboard.classList.add('hidden');
            loadingScreen.classList.add('hidden');
        }

        function restoreScreen(screenType) {
            switch (screenType) {
                case 'admin':
                    showAdminPanel();
                    break;
                case 'dashboard':
                    showDashboard();
                    break;
                default:
                    showLoginScreen();
                    break;
            }
        }

        async function ensureDataLoaded() {
            await new Promise(resolve => setTimeout(resolve, 50));
        }

        function downloadHTMLFile(htmlContent, filename) {
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = filename;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(downloadLink.href);
        }

        // ===== UTILIDADES =====

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium transition-all transform translate-x-full`;
            
            if (type === 'success') {
                notification.className += ' bg-green-500';
            } else if (type === 'error') {
                notification.className += ' bg-red-500';
            } else if (type === 'info') {
                notification.className += ' bg-blue-500';
            } else {
                notification.className += ' bg-gray-500';
            }
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ===== GESTIÃ“N DE ADMINISTRADORES =====

        function openAddAdminModal() {
            const modal = document.getElementById('addAdminModal');
            document.getElementById('addAdminForm').reset();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeAddAdminModal() {
            const modal = document.getElementById('addAdminModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function saveNewAdmin(e) {
            e.preventDefault();
            
            const adminData = {
                username: document.getElementById('newAdminId').value,
                name: document.getElementById('newAdminName').value,
                department: document.getElementById('newAdminDepartment').value,
                password: document.getElementById('newAdminPassword').value,
                role: 'admin'
            };

            try {
                // Verificar que el ID no exista
                if (userCredentials[adminData.username]) {
                    throw new Error('El ID de administrador ya existe');
                }

                // Agregar a credenciales
                userCredentials[adminData.username] = {
                    password: adminData.password,
                    role: 'admin',
                    name: adminData.name,
                    department: adminData.department
                };

                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    
                    // Guardar admin en Firestore
                    await setDoc(doc(window.firebaseDb, 'admins', adminData.username), adminData);
                    
                    // Actualizar credenciales en Firebase
                    await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
                }

                // Actualizar dropdown de login
                updateAdminDropdown();
                
                closeAddAdminModal();
                showNotification('âœ… Administrador creado correctamente');
                
            } catch (error) {
                console.error('Error creando administrador:', error);
                showNotification('âŒ Error al crear el administrador: ' + error.message, 'error');
            }
        }

        function updateAdminDropdown() {
            const adminSelect = document.getElementById('adminSelect');
            const currentOptions = Array.from(adminSelect.options).map(opt => opt.value);
            
            // Agregar nuevos administradores al dropdown
            Object.keys(userCredentials).forEach(username => {
                if (userCredentials[username].role === 'admin' && !currentOptions.includes(username)) {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = `${username} - ${userCredentials[username].department}`;
                    adminSelect.appendChild(option);
                }
            });
        }

        async function openManageAdminsModal() {
            const modal = document.getElementById('manageAdminsModal');
            await loadAdminsTable();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeManageAdminsModal() {
            const modal = document.getElementById('manageAdminsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function loadAdminsTable() {
            const tbody = document.getElementById('adminsTableBody');
            tbody.innerHTML = '';

            try {
                const adminList = Object.keys(userCredentials).filter(username => 
                    userCredentials[username].role === 'admin'
                );

                for (const adminId of adminList) {
                    const adminData = userCredentials[adminId];
                    
                    // Contar usuarios de este admin
                    let userCount = 0;
                    if (isFirebaseInitialized) {
                        const { getDocs, collection, query, where } = window.firebaseFunctions;
                        const usersQuery = query(
                            collection(window.firebaseDb, 'users'),
                            where('adminId', '==', adminId)
                        );
                        const querySnapshot = await getDocs(usersQuery);
                        userCount = querySnapshot.size;
                    } else {
                        userCount = defaultData.defaultUsers.filter(user => user.adminId === adminId).length;
                    }

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold">${adminId}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${adminData.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${adminData.department}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-center">${userCount}</td>
                        <td class="px-4 py-3 text-sm space-x-2">
                            <button onclick="deleteAdmin('${adminId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-all">
                                ğŸ—‘ï¸ Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
                
            } catch (error) {
                console.error('Error cargando administradores:', error);
                showNotification('âŒ Error cargando administradores', 'error');
            }
        }

        let adminToDelete = null;

        function deleteAdmin(adminId) {
            adminToDelete = adminId;
            const adminData = userCredentials[adminId];
            document.getElementById('adminToDeleteName').textContent = `${adminData.name} (${adminId})`;
            
            const modal = document.getElementById('confirmDeleteAdminModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDeleteAdminModal() {
            const modal = document.getElementById('confirmDeleteAdminModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            adminToDelete = null;
        }

        async function confirmDeleteAdmin() {
            if (!adminToDelete) return;

            try {
                // No permitir eliminar el admin actual
                if (adminToDelete === currentUser.username) {
                    throw new Error('No puedes eliminar tu propia cuenta de administrador');
                }

                if (isFirebaseInitialized) {
                    const { deleteDoc, doc, getDocs, collection, query, where } = window.firebaseFunctions;
                    
                    // Eliminar todos los usuarios de este admin
                    const usersQuery = query(
                        collection(window.firebaseDb, 'users'),
                        where('adminId', '==', adminToDelete)
                    );
                    const querySnapshot = await getDocs(usersQuery);
                    
                    const deletePromises = [];
                    querySnapshot.forEach((userDoc) => {
                        deletePromises.push(deleteDoc(doc(window.firebaseDb, 'users', userDoc.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // Eliminar el admin
                    await deleteDoc(doc(window.firebaseDb, 'admins', adminToDelete));
                }

                // Eliminar de credenciales locales
                delete userCredentials[adminToDelete];

                // Eliminar usuarios asociados de datos locales
                defaultData.defaultUsers = defaultData.defaultUsers.filter(user => 
                    user.adminId !== adminToDelete
                );

                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
                }

                // Actualizar dropdown
                const adminSelect = document.getElementById('adminSelect');
                const optionToRemove = adminSelect.querySelector(`option[value="${adminToDelete}"]`);
                if (optionToRemove) {
                    optionToRemove.remove();
                }

                closeDeleteAdminModal();
                await loadAdminsTable();
                showNotification('âœ… Administrador y sus usuarios eliminados correctamente');
                
            } catch (error) {
                console.error('Error eliminando administrador:', error);
                showNotification('âŒ Error al eliminar el administrador: ' + error.message, 'error');
            }
        }

        // Hacer funciones globales para los botones inline
        window.editUser = editUser;
        window.showUserDetails = showUserDetails;
        window.deleteUser = deleteUser;
        window.removeCategory = removeCategory;
        window.addCriteria = addCriteria;
        window.removeCriteria = removeCriteria;
        window.deleteAdmin = deleteAdmin;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'979e78cfa73b38ef',t:'MTc1Njk5OTIzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
