<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n Modular - Universidad Virtual CNCI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDf2ns9wzXixZHiWO5_kL1OnDr9iYbAaTI",
            authDomain: "instrumentoevaluacioncnci.firebaseapp.com",
            projectId: "instrumentoevaluacioncnci",
            storageBucket: "instrumentoevaluacioncnci.firebasestorage.app",
            messagingSenderId: "979030591942",
            appId: "1:979030591942:web:5efcac6a4675de473a4ac7",
            measurementId: "G-4PDCMV8LC4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        
        // Firebase functions
        window.firebaseFunctions = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where
        };
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #2a6aff 0%, #ff8500 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(42, 106, 255, 0.1);
        }
        .tab-active {
            background: linear-gradient(135deg, #2a6aff, #ff8500);
            color: white;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2a6aff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">üîß Configurando Firebase</h2>
            <p class="text-gray-600">Inicializando base de datos...</p>
            <div id="initProgress" class="mt-4 text-sm text-[#2a6aff]">Conectando...</div>
        </div>
    </div>

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo Universidad Virtual CNCI" class="mx-auto mb-6 h-20 object-contain">
                <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">üìä Evaluaci√≥n Modular</h1>
                <h2 id="loginSubtitle" class="text-lg text-[#2a6aff] font-semibold mb-1">Universidad Virtual CNCI</h2>
                <p id="loginDepartment" class="text-[#ff8500] font-medium mb-4">Departamento de Servicios Estudiantiles</p>
                <p id="loginDescription" class="text-gray-600 text-sm">üîç Consulta tu desempe√±o del m√≥dulo de manera detallada ingresando tu usuario</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">üë§ Usuario</label>
                    <input type="text" id="username" required placeholder="Ej: usuario01, admin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff] focus:border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">üîí Contrase√±a</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff] focus:border-transparent transition-all">
                </div>
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all transform hover:scale-105">
                    üöÄ Consultar mi Evaluaci√≥n
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                ‚ùå Error en el inicio de sesi√≥n. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="adminPanel" class="min-h-screen p-6 hidden">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">
                <!-- Header con botones -->
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">üë®‚Äçüíº Panel de Administrador</h1>
                    <div class="space-x-4">
                        <button id="initFirebaseBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-all">
                            üîß Inicializar Firebase
                        </button>
                        <button id="downloadCSVBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-all">
                            üì• Descargar Plantilla CSV
                        </button>
                        <button id="uploadCSVBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-all">
                            üì§ Cargar CSV
                        </button>
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                        <button id="clearTableBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-all">
                            üóëÔ∏è Vaciar Tabla
                        </button>
                        <button id="adminLogout" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-all">
                            üö™ Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>

                <!-- Estado de Firebase -->
                <div id="firebaseStatus" class="mb-8 p-4 rounded-lg border">
                    <h3 class="font-semibold mb-2">üî• Estado de Firebase</h3>
                    <div id="statusContent" class="text-sm text-gray-600">
                        Verificando conexi√≥n...
                    </div>
                </div>

                <!-- Secci√≥n de Edici√≥n General -->
                <div class="mb-8 bg-gray-50 rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Edici√≥n General</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">T√≠tulo Principal</label>
                            <input type="text" id="mainTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Evaluaci√≥n Modular ‚Äì Universidad Virtual CNCI">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Subt√≠tulo</label>
                            <input type="text" id="subtitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Universidad Virtual CNCI">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Departamento</label>
                            <input type="text" id="department" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Departamento de Servicios Estudiantiles">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Descripci√≥n</label>
                            <input type="text" id="description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]" value="Consulta tu desempe√±o del m√≥dulo de manera detallada ingresando tu usuario">
                        </div>
                        <div class="md:col-span-2">
                            <button id="saveLoginTexts" class="bg-[#2a6aff] hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-all">
                                üíæ Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Usuarios -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üë• Tabla de Edici√≥n de Usuarios</h2>
                        <button id="addUserBtn" class="bg-[#ff8500] hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-all">
                            ‚ûï A√±adir Usuario
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Usuario</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nombre</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Contrase√±a</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Puntaje General</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Comentarios</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Los usuarios se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Secci√≥n de Categor√≠as -->
                <div class="mb-8 bg-gray-50 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìã Edici√≥n de Categor√≠as y Criterios de Evaluaci√≥n</h2>
                        <button id="editCategoriesBtn" class="bg-[#2a6aff] hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-all">
                            ‚úèÔ∏è Editar Categor√≠as
                        </button>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="text-blue-600">üîÑ</div>
                            <div>
                                <h4 class="font-semibold text-blue-800">Sincronizaci√≥n Autom√°tica</h4>
                                <p class="text-sm text-blue-600">Los cambios en categor√≠as y criterios se aplicar√°n autom√°ticamente a todos los usuarios existentes.</p>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Modales (mantienen la misma estructura) -->
    <!-- Modal A√±adir/Editar Usuario -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="userModalTitle" class="text-xl font-bold text-gray-800">‚ûï A√±adir Usuario</h3>
                <button id="closeUserModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="userForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ID Usuario</label>
                    <input type="text" id="userId" required placeholder="usuario01, usuario02..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nombre</label>
                    <input type="text" id="userNameInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Puntaje General (Calculado Autom√°ticamente)</label>
                    <input type="text" id="userGeneralScore" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600" placeholder="Se calcula autom√°ticamente del promedio de categor√≠as">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Contrase√±a</label>
                    <input type="password" id="userPassword" placeholder="Dejar vac√≠o para mantener actual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                    <p class="text-xs text-gray-500 mt-1">üí° Dejar vac√≠o para no cambiar la contrase√±a</p>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Comentarios</label>
                    <textarea id="userComments" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-[#2a6aff] hover:bg-blue-600 text-white py-2 rounded-lg transition-all">
                        üíæ Guardar
                    </button>
                    <button type="button" id="cancelUserModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        ‚ùå Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalles de Usuario -->
    <div id="userDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">üìä Detalles del Usuario</h3>
                <button id="closeDetailsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="userDetailsForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">ID Usuario</label>
                        <input type="text" id="detailsUserId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nombre</label>
                        <input type="text" id="detailsUserName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Puntaje General (Calculado Autom√°ticamente)</label>
                        <input type="text" id="detailsGeneralScore" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600" placeholder="Se calcula del promedio de categor√≠as">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Rol</label>
                        <select id="detailsUserRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nueva Contrase√±a</label>
                        <input type="password" id="detailsUserPassword" placeholder="Dejar vac√≠o para mantener actual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]">
                        <p class="text-xs text-gray-500 mt-1">üí° Solo completar si deseas cambiar la contrase√±a</p>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Comentarios Generales</label>
                    <textarea id="detailsGeneralComments" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                </div>
                <!-- Secci√≥n de Insignias -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üèÜ Insignias del Usuario</h4>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
                            <input type="checkbox" id="badgeExcellence" class="mb-2">
                            <div class="text-3xl mb-2">ü•á</div>
                            <label for="badgeExcellence" class="font-semibold text-yellow-800 cursor-pointer">Excelencia</label>
                            <p class="text-xs text-yellow-600 mt-1">Calificaci√≥n superior a 90</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                            <input type="checkbox" id="badgeCommunicator" class="mb-2">
                            <div class="text-3xl mb-2">üìû</div>
                            <label for="badgeCommunicator" class="font-semibold text-blue-800 cursor-pointer">Comunicador</label>
                            <p class="text-xs text-blue-600 mt-1">Excelente en llamadas</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg text-center">
                            <input type="checkbox" id="badgeConsistent" class="mb-2">
                            <div class="text-3xl mb-2">‚≠ê</div>
                            <label for="badgeConsistent" class="font-semibold text-green-800 cursor-pointer">Consistente</label>
                            <p class="text-xs text-green-600 mt-1">Desempe√±o estable</p>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de Plan de Trabajo -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìã Plan de Mejora Personalizado</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">üéØ Objetivos del Pr√≥ximo Per√≠odo</label>
                            <textarea id="userObjectives" rows="3" placeholder="Ej: Mejorar seguimiento a poblaci√≥n morosa, Incrementar reingresos..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">üìö Recursos Recomendados</label>
                            <textarea id="userResources" rows="3" placeholder="Ej: Manual de retenci√≥n estudiantil, Curso de comunicaci√≥n efectiva..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">üí° Notas Adicionales</label>
                            <textarea id="userAdditionalNotes" rows="2" placeholder="Observaciones especiales, fortalezas destacadas..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2a6aff]"></textarea>
                        </div>
                    </div>
                </div>

                <div id="categoriesSection">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìã Categor√≠as de Evaluaci√≥n</h4>
                    <div id="categoriesContainer" class="space-y-4">
                        <!-- Las categor√≠as se cargar√°n din√°micamente -->
                    </div>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-[#2a6aff] hover:bg-blue-600 text-white py-2 rounded-lg transition-all">
                        üíæ Guardar Cambios
                    </button>
                    <button type="button" id="cancelDetailsModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        ‚ùå Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n Vaciar Tabla -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Acci√≥n</h3>
                <p class="text-gray-600 mb-6">¬øEst√°s seguro de que deseas eliminar todos los usuarios? Esta acci√≥n no se puede deshacer.</p>
                <div class="flex space-x-4">
                    <button id="confirmClear" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition-all">
                        üóëÔ∏è S√≠, Eliminar
                    </button>
                    <button id="cancelClear" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                        ‚ùå Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Categor√≠as -->
    <div id="categoriesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">üìã Editar Categor√≠as y Criterios</h3>
                <button id="closeCategoriesModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <button id="addCategoryBtn" class="bg-[#ff8500] hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all">
                    ‚ûï A√±adir Categor√≠a
                </button>
            </div>
            <div id="categoriesEditContainer" class="space-y-4 mb-6">
                <!-- Las categor√≠as se cargar√°n din√°micamente -->
            </div>
            <div class="flex space-x-4">
                <button id="saveCategoriesBtn" class="flex-1 bg-[#2a6aff] hover:bg-blue-600 text-white py-2 rounded-lg transition-all">
                    üíæ Guardar Cambios
                </button>
                <button id="cancelCategoriesBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-all">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard" class="min-h-screen p-6 hidden">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">üìä Dashboard de Evaluaci√≥n</h1>
                        <p class="text-gray-600 mt-1">Bienvenido, <span id="userName" class="text-[#2a6aff] font-semibold"></span></p>
                    </div>
                    <button id="backToLogin" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-all">
                        ‚Üê Volver
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-2xl shadow-2xl mb-6 fade-in">
                <div class="flex border-b border-gray-200">
                    <button class="tab-button tab-active px-6 py-4 font-semibold rounded-tl-2xl transition-all" data-tab="resumen">
                        üìà Resumen General
                    </button>
                    <button class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-[#2a6aff] transition-all" data-tab="insignias">
                        üèÜ Insignias
                    </button>
                    <button class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-[#2a6aff] rounded-tr-2xl transition-all" data-tab="plan">
                        üìã Plan de Trabajo
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Resumen General -->
                    <div id="resumen" class="tab-content">
                        <div class="grid md:grid-cols-1 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-[#2a6aff] to-blue-600 text-white p-6 rounded-xl card-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold mb-2">üéØ Calificaci√≥n General</h3>
                                        <p class="text-3xl font-bold" id="generalScore">--</p>
                                    </div>
                                    <div class="text-4xl opacity-80">üìä</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">üìã Categor√≠as y Criterios de Evaluaci√≥n</h3>
                            <div id="evaluationCategories" class="grid gap-6">
                                <!-- Las categor√≠as se cargar√°n din√°micamente -->
                            </div>
                        </div>

                        <div class="mt-8 bg-gray-50 p-6 rounded-xl">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">üí¨ Comentarios Generales</h4>
                            <p id="generalComments" class="text-gray-600">Cargando comentarios...</p>
                        </div>
                    </div>

                    <!-- Insignias -->
                    <div id="insignias" class="tab-content hidden">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">üèÜ Mis Insignias</h3>
                        <div id="userBadges" class="grid md:grid-cols-3 gap-6 mb-8">
                            <!-- Las insignias se cargar√°n din√°micamente -->
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">üìã Todas las Insignias Disponibles</h4>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="bg-yellow-50 border-2 border-yellow-200 p-6 rounded-xl text-center opacity-60">
                                    <div class="text-4xl mb-3">ü•á</div>
                                    <h4 class="font-semibold text-yellow-800">Excelencia</h4>
                                    <p class="text-sm text-yellow-600 mt-2">Calificaci√≥n superior a 90</p>
                                </div>
                                <div class="bg-blue-50 border-2 border-blue-200 p-6 rounded-xl text-center opacity-60">
                                    <div class="text-4xl mb-3">üìû</div>
                                    <h4 class="font-semibold text-blue-800">Comunicador</h4>
                                    <p class="text-sm text-blue-600 mt-2">Excelente en llamadas</p>
                                </div>
                                <div class="bg-green-50 border-2 border-green-200 p-6 rounded-xl text-center opacity-60">
                                    <div class="text-4xl mb-3">‚≠ê</div>
                                    <h4 class="font-semibold text-green-800">Consistente</h4>
                                    <p class="text-sm text-green-600 mt-2">Desempe√±o estable</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Plan de Trabajo -->
                    <div id="plan" class="tab-content hidden">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">üìã Mi Plan de Mejora Personalizado</h3>
                        <div class="space-y-6">
                            <div class="bg-blue-50 border-l-4 border-[#2a6aff] p-6 rounded-r-lg">
                                <h4 class="font-semibold text-[#2a6aff] mb-3">üéØ Objetivos del Pr√≥ximo Per√≠odo</h4>
                                <div id="userObjectivesDisplay" class="text-gray-700 whitespace-pre-line">
                                    Cargando objetivos personalizados...
                                </div>
                            </div>
                            <div class="bg-orange-50 border-l-4 border-[#ff8500] p-6 rounded-r-lg">
                                <h4 class="font-semibold text-[#ff8500] mb-3">üìö Recursos Recomendados</h4>
                                <div id="userResourcesDisplay" class="text-gray-700 whitespace-pre-line">
                                    Cargando recursos personalizados...
                                </div>
                            </div>
                            <div id="additionalNotesSection" class="bg-green-50 border-l-4 border-green-500 p-6 rounded-r-lg">
                                <h4 class="font-semibold text-green-700 mb-3">üí° Notas Adicionales</h4>
                                <div id="userAdditionalNotesDisplay" class="text-gray-700 whitespace-pre-line">
                                    Cargando notas adicionales...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let evaluationTemplate = null;
        let allUsers = [];
        let currentEditingUser = null;
        let categoriesData = [];
        let isFirebaseInitialized = false;

        // Sistema de autenticaci√≥n local (m√°s confiable)
        const defaultCredentials = {
            'admin': { password: 'admin123', role: 'admin' },
            'usuario01': { password: 'password123', role: 'user' },
            'usuario02': { password: 'password123', role: 'user' },
            'usuario03': { password: 'password123', role: 'user' },
            'usuario04': { password: 'password123', role: 'user' },
            'usuario05': { password: 'password123', role: 'user' },
            'usuario06': { password: 'password123', role: 'user' },
            'usuario07': { password: 'password123', role: 'user' },
            'usuario08': { password: 'password123', role: 'user' },
            'usuario09': { password: 'password123', role: 'user' },
            'usuario10': { password: 'password123', role: 'user' },
            'usuario11': { password: 'password123', role: 'user' },
            'usuario12': { password: 'password123', role: 'user' },
            'usuario13': { password: 'password123', role: 'user' },
            'usuario14': { password: 'password123', role: 'user' },
            'usuario15': { password: 'password123', role: 'user' },
            'usuario16': { password: 'password123', role: 'user' },
            'usuario17': { password: 'password123', role: 'user' },
            'usuario18': { password: 'password123', role: 'user' }
        };

        // Mapeo de nicknames a emails (para Firebase cuando est√© disponible)
        const nicknameToEmail = {
            'admin': 'admin@cnci.edu.mx',
            'usuario01': 'usuario01@cnci.edu.mx',
            'usuario02': 'usuario02@cnci.edu.mx',
            'usuario03': 'usuario03@cnci.edu.mx',
            'usuario04': 'usuario04@cnci.edu.mx',
            'usuario05': 'usuario05@cnci.edu.mx',
            'usuario06': 'usuario06@cnci.edu.mx',
            'usuario07': 'usuario07@cnci.edu.mx',
            'usuario08': 'usuario08@cnci.edu.mx',
            'usuario09': 'usuario09@cnci.edu.mx',
            'usuario10': 'usuario10@cnci.edu.mx',
            'usuario11': 'usuario11@cnci.edu.mx',
            'usuario12': 'usuario12@cnci.edu.mx',
            'usuario13': 'usuario13@cnci.edu.mx',
            'usuario14': 'usuario14@cnci.edu.mx',
            'usuario15': 'usuario15@cnci.edu.mx',
            'usuario16': 'usuario16@cnci.edu.mx',
            'usuario17': 'usuario17@cnci.edu.mx',
            'usuario18': 'usuario18@cnci.edu.mx'
        };

        // Almac√©n de credenciales (se sincroniza con Firebase cuando est√° disponible)
        let userCredentials = { ...defaultCredentials };

        // Datos por defecto para inicializaci√≥n
        const defaultData = {
            loginTexts: {
                mainTitle: 'Evaluaci√≥n Modular',
                subtitle: 'Universidad Virtual CNCI',
                department: 'Departamento de Servicios Estudiantiles',
                description: 'Consulta tu desempe√±o del m√≥dulo de manera detallada ingresando tu usuario'
            },
            evaluationTemplate: {
                categories: [
                    {
                        name: 'RETENCI√ìN',
                        criteria: ['Seguimiento a poblaci√≥n morosa', 'Total de bajas de alumnos con morosidad', 'Uso adecuado y oportuno de la columna de retenci√≥n de CRM', 'Retenci√≥n y bajas pagadas']
                    },
                    {
                        name: 'REINCORPORACI√ìN',
                        criteria: ['Bajas por no pago', 'B√∫squeda y difusi√≥n de promociones', 'Registro y seguimiento', 'Cierre de prospectos', 'Total de reingresos']
                    },
                    {
                        name: 'PROCESOS',
                        criteria: ['B√∫squeda de alumnos por estatus y perfil: semana 1 a la semana 4', 'Procesos acad√©micos', 'Tr√°mites escolares']
                    },
                    {
                        name: 'LLAMADA',
                        criteria: ['Se presenta con su nombre e identificaci√≥n de la Universidad', 'Maneja motivo de la llamada de manera adecuada']
                    },
                    {
                        name: 'WHATSAPP',
                        criteria: ['Emplea redacci√≥n adecuada', 'Crea bocetos', 'Responde todos los mensajes', 'Contesta preguntas en un rango de 12 horas o menos', 'Brinda soluciones pertinentes', 'Propone llamada para una mejor explicaci√≥n', 'Es emp√°tico (a)']
                    },
                    {
                        name: 'CORREO ELECTR√ìNICO',
                        criteria: ['Emplea redacci√≥n adecuada', 'Crea bocetos previos a enviar', 'Responde todos los mensajes', 'Contesta preguntas en un rango de 12 horas o menos', 'Atiende en tiempo la asignaci√≥n de correos institucionales', 'Brinda soluciones pertinentes', 'Propone llamada para una mejor explicaci√≥n', 'Es emp√°tico (a)', 'Mantiene control sobre sus emociones en casos dif√≠ciles']
                    },
                    {
                        name: 'VIVA ENGAGE',
                        criteria: ['La reuni√≥n previa a la publicaci√≥n se realiza de forma exitosa', 'Se nota una excelente organizaci√≥n y trabajo en equipo', 'Se utilizan im√°genes, videos o elementos gr√°ficos llamativos y bien dise√±ados', 'Se publica en la fecha establecida sin retrasos']
                    },
                    {
                        name: 'ACTIVIDADES ADMINISTRATIVAS',
                        criteria: ['Asigna y actualiza perfiles', 'Especifica a trav√©s de que medio abord√≥ al alumno', 'Registra en tiempo (diario) sus actividades en el reporte de seguimiento CRM', 'Organiza sus tiempos para cumplir con el % m√≠nimo (90%) de contactaci√≥n', 'Logra el % m√≠nimo de contactaci√≥n']
                    }
                ]
            },
            defaultUsers: [
                {
                    username: 'usuario01',
                    name: 'Mar√≠a Gonz√°lez P√©rez',
                    role: 'user',
                    password: 'password123',
                    generalScore: 87,
                    generalComments: 'Excelente desempe√±o en retenci√≥n y reincorporaci√≥n. Se destaca por su seguimiento oportuno a estudiantes morosos y uso efectivo del CRM.',
                    badges: {
                        excellence: false,
                        communicator: true,
                        consistent: true
                    },
                    workPlan: {
                        objectives: 'Mejorar seguimiento a poblaci√≥n morosa\nIncrementar reingresos de estudiantes\nOptimizar procesos acad√©micos',
                        resources: 'Manual de retenci√≥n estudiantil\nCurso de comunicaci√≥n efectiva\nTaller de uso de CRM',
                        additionalNotes: 'Estudiante destacada en comunicaci√≥n. Continuar fortaleciendo habilidades t√©cnicas.'
                    },
                    categories: {
                        'RETENCI√ìN': { 
                            score: 9.0, 
                            criteria: [
                                { name: 'Seguimiento a poblaci√≥n morosa', score: 9.0 },
                                { name: 'Total de bajas de alumnos con morosidad', score: 8.5 },
                                { name: 'Uso adecuado y oportuno de la columna de retenci√≥n de CRM', score: 9.5 },
                                { name: 'Retenci√≥n y bajas pagadas', score: 9.0 }
                            ]
                        },
                        'REINCORPORACI√ìN': { 
                            score: 8.5, 
                            criteria: [
                                { name: 'Bajas por no pago', score: 8.0 },
                                { name: 'B√∫squeda y difusi√≥n de promociones', score: 9.0 },
                                { name: 'Registro y seguimiento', score: 8.5 },
                                { name: 'Cierre de prospectos', score: 8.0 },
                                { name: 'Total de reingresos', score: 9.0 }
                            ]
                        },
                        'PROCESOS': { 
                            score: 8.8, 
                            criteria: [
                                { name: 'B√∫squeda de alumnos por estatus y perfil: semana 1 a la semana 4', score: 9.0 },
                                { name: 'Procesos acad√©micos', score: 8.5 },
                                { name: 'Tr√°mites escolares', score: 9.0 }
                            ]
                        },
                        'LLAMADA': { 
                            score: 9.2, 
                            criteria: [
                                { name: 'Se presenta con su nombre e identificaci√≥n de la Universidad', score: 9.5 },
                                { name: 'Maneja motivo de la llamada de manera adecuada', score: 8.9 }
                            ]
                        },
                        'WHATSAPP': { 
                            score: 8.3, 
                            criteria: [
                                { name: 'Emplea redacci√≥n adecuada', score: 8.5 },
                                { name: 'Crea bocetos', score: 8.0 },
                                { name: 'Responde todos los mensajes', score: 9.0 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 8.0 },
                                { name: 'Brinda soluciones pertinentes', score: 8.5 },
                                { name: 'Propone llamada para una mejor explicaci√≥n', score: 8.0 },
                                { name: 'Es emp√°tico (a)', score: 8.1 }
                            ]
                        },
                        'CORREO ELECTR√ìNICO': { 
                            score: 8.9, 
                            criteria: [
                                { name: 'Emplea redacci√≥n adecuada', score: 9.0 },
                                { name: 'Crea bocetos previos a enviar', score: 8.5 },
                                { name: 'Responde todos los mensajes', score: 9.0 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 9.5 },
                                { name: 'Atiende en tiempo la asignaci√≥n de correos institucionales', score: 8.5 },
                                { name: 'Brinda soluciones pertinentes', score: 9.0 },
                                { name: 'Propone llamada para una mejor explicaci√≥n', score: 8.5 },
                                { name: 'Es emp√°tico (a)', score: 9.0 },
                                { name: 'Mantiene control sobre sus emociones en casos dif√≠ciles', score: 9.1 }
                            ]
                        },
                        'VIVA ENGAGE': { 
                            score: 8.6, 
                            criteria: [
                                { name: 'La reuni√≥n previa a la publicaci√≥n se realiza de forma exitosa', score: 8.5 },
                                { name: 'Se nota una excelente organizaci√≥n y trabajo en equipo', score: 9.0 },
                                { name: 'Se utilizan im√°genes, videos o elementos gr√°ficos llamativos y bien dise√±ados', score: 8.0 },
                                { name: 'Se publica en la fecha establecida sin retrasos', score: 8.9 }
                            ]
                        },
                        'ACTIVIDADES ADMINISTRATIVAS': { 
                            score: 9.1, 
                            criteria: [
                                { name: 'Asigna y actualiza perfiles', score: 9.0 },
                                { name: 'Especifica a trav√©s de que medio abord√≥ al alumno', score: 9.5 },
                                { name: 'Registra en tiempo (diario) sus actividades en el reporte de seguimiento CRM', score: 9.0 },
                                { name: 'Organiza sus tiempos para cumplir con el % m√≠nimo (90%) de contactaci√≥n', score: 8.5 },
                                { name: 'Logra el % m√≠nimo de contactaci√≥n', score: 9.5 }
                            ]
                        }
                    }
                },
                {
                    username: 'usuario02',
                    name: 'Carlos Rodr√≠guez L√≥pez',
                    role: 'user',
                    password: 'password123',
                    generalScore: 92,
                    generalComments: 'Muy buen desempe√±o general. Excelente manejo de procesos acad√©micos y comunicaci√≥n con estudiantes.',
                    badges: {
                        excellence: true,
                        communicator: true,
                        consistent: true
                    },
                    workPlan: {
                        objectives: 'Mantener excelencia en todas las √°reas\nMentor√≠a a nuevos compa√±eros\nLiderar proyectos de mejora continua',
                        resources: 'Certificaci√≥n avanzada en CRM\nCurso de liderazgo\nTaller de mentoring',
                        additionalNotes: 'Empleado modelo con todas las insignias. Candidato ideal para roles de liderazgo.'
                    },
                    categories: {
                        'RETENCI√ìN': { 
                            score: 9.5, 
                            criteria: [
                                { name: 'Seguimiento a poblaci√≥n morosa', score: 9.5 },
                                { name: 'Total de bajas de alumnos con morosidad', score: 9.0 },
                                { name: 'Uso adecuado y oportuno de la columna de retenci√≥n de CRM', score: 10.0 },
                                { name: 'Retenci√≥n y bajas pagadas', score: 9.5 }
                            ]
                        },
                        'REINCORPORACI√ìN': { 
                            score: 9.0, 
                            criteria: [
                                { name: 'Bajas por no pago', score: 9.0 },
                                { name: 'B√∫squeda y difusi√≥n de promociones', score: 9.5 },
                                { name: 'Registro y seguimiento', score: 8.5 },
                                { name: 'Cierre de prospectos', score: 9.0 },
                                { name: 'Total de reingresos', score: 9.0 }
                            ]
                        },
                        'PROCESOS': { 
                            score: 9.1, 
                            criteria: [
                                { name: 'B√∫squeda de alumnos por estatus y perfil: semana 1 a la semana 4', score: 9.0 },
                                { name: 'Procesos acad√©micos', score: 9.5 },
                                { name: 'Tr√°mites escolares', score: 8.8 }
                            ]
                        },
                        'LLAMADA': { 
                            score: 9.4, 
                            criteria: [
                                { name: 'Se presenta con su nombre e identificaci√≥n de la Universidad', score: 9.5 },
                                { name: 'Maneja motivo de la llamada de manera adecuada', score: 9.3 }
                            ]
                        },
                        'WHATSAPP': { 
                            score: 8.8, 
                            criteria: [
                                { name: 'Emplea redacci√≥n adecuada', score: 9.0 },
                                { name: 'Crea bocetos', score: 8.5 },
                                { name: 'Responde todos los mensajes', score: 9.5 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 8.5 },
                                { name: 'Brinda soluciones pertinentes', score: 9.0 },
                                { name: 'Propone llamada para una mejor explicaci√≥n', score: 8.5 },
                                { name: 'Es emp√°tico (a)', score: 8.6 }
                            ]
                        },
                        'CORREO ELECTR√ìNICO': { 
                            score: 9.3, 
                            criteria: [
                                { name: 'Emplea redacci√≥n adecuada', score: 9.5 },
                                { name: 'Crea bocetos previos a enviar', score: 9.0 },
                                { name: 'Responde todos los mensajes', score: 9.5 },
                                { name: 'Contesta preguntas en un rango de 12 horas o menos', score: 9.0 },
                                { name: 'Atiende en tiempo la asignaci√≥n de correos institucionales', score: 9.5 },
                                { name: 'Brinda soluciones pertinentes', score: 9.0 },
                                { name: 'Propone llamada para una mejor explicaci√≥n', score: 9.5 },
                                { name: 'Es emp√°tico (a)', score: 9.0 },
                                { name: 'Mantiene control sobre sus emociones en casos dif√≠ciles', score: 9.7 }
                            ]
                        },
                        'VIVA ENGAGE': { 
                            score: 8.9, 
                            criteria: [
                                { name: 'La reuni√≥n previa a la publicaci√≥n se realiza de forma exitosa', score: 9.0 },
                                { name: 'Se nota una excelente organizaci√≥n y trabajo en equipo', score: 9.5 },
                                { name: 'Se utilizan im√°genes, videos o elementos gr√°ficos llamativos y bien dise√±ados', score: 8.0 },
                                { name: 'Se publica en la fecha establecida sin retrasos', score: 9.1 }
                            ]
                        },
                        'ACTIVIDADES ADMINISTRATIVAS': { 
                            score: 9.6, 
                            criteria: [
                                { name: 'Asigna y actualiza perfiles', score: 9.5 },
                                { name: 'Especifica a trav√©s de que medio abord√≥ al alumno', score: 10.0 },
                                { name: 'Registra en tiempo (diario) sus actividades en el reporte de seguimiento CRM', score: 9.5 },
                                { name: 'Organiza sus tiempos para cumplir con el % m√≠nimo (90%) de contactaci√≥n', score: 9.0 },
                                { name: 'Logra el % m√≠nimo de contactaci√≥n', score: 10.0 }
                            ]
                        }
                    }
                }
            ]
        };

        // Elementos del DOM
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const adminPanel = document.getElementById('adminPanel');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ===== INICIALIZACI√ìN DE LA APLICACI√ìN =====

        async function initializeApp() {
            try {
                updateInitProgress('Verificando Firebase...');
                await checkFirebaseConnection();
                
                updateInitProgress('Cargando configuraci√≥n...');
                await loadConfiguration();
                
                updateInitProgress('Configurando eventos...');
                setupEventListeners();
                
                updateInitProgress('¬°Listo!');
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Error inicializando aplicaci√≥n:', error);
                updateInitProgress('Error de conexi√≥n. Usando modo offline...');
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }, 2000);
            }
        }

        function updateInitProgress(message) {
            document.getElementById('initProgress').textContent = message;
        }

        async function checkFirebaseConnection() {
            try {
                const { getDoc, doc } = window.firebaseFunctions;
                const testDoc = await getDoc(doc(window.firebaseDb, 'test', 'connection'));
                isFirebaseInitialized = true;
                updateFirebaseStatus('üü¢ Conectado', 'text-green-600');
            } catch (error) {
                console.log('Firebase no inicializado, usando datos locales');
                isFirebaseInitialized = false;
                updateFirebaseStatus('üü° Modo Local', 'text-yellow-600');
            }
        }

        function updateFirebaseStatus(message, className) {
            const statusElement = document.getElementById('statusContent');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `text-sm ${className}`;
            }
        }

        async function loadConfiguration() {
            if (isFirebaseInitialized) {
                try {
                    await loadConfigFromFirebase();
                    await loadCredentialsFromFirebase();
                } catch (error) {
                    console.log('Usando configuraci√≥n por defecto');
                    loadDefaultConfiguration();
                }
            } else {
                loadDefaultConfiguration();
            }
        }

        async function loadCredentialsFromFirebase() {
            try {
                const { getDoc, doc } = window.firebaseFunctions;
                const credentialsDoc = await getDoc(doc(window.firebaseDb, 'config', 'userCredentials'));
                if (credentialsDoc.exists()) {
                    userCredentials = { ...defaultCredentials, ...credentialsDoc.data() };
                }
            } catch (error) {
                console.log('Usando credenciales por defecto');
                userCredentials = { ...defaultCredentials };
            }
        }

        async function loadConfigFromFirebase() {
            const { getDoc, doc } = window.firebaseFunctions;
            
            // Cargar textos de login
            const loginTextsDoc = await getDoc(doc(window.firebaseDb, 'config', 'loginTexts'));
            if (loginTextsDoc.exists()) {
                const loginTexts = loginTextsDoc.data();
                updateLoginTexts(loginTexts);
            }
            
            // Cargar template de evaluaci√≥n
            const templateDoc = await getDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'));
            if (templateDoc.exists()) {
                evaluationTemplate = templateDoc.data();
                categoriesData = evaluationTemplate.categories || [];
            }
        }

        function loadDefaultConfiguration() {
            updateLoginTexts(defaultData.loginTexts);
            evaluationTemplate = defaultData.evaluationTemplate;
            categoriesData = defaultData.evaluationTemplate.categories;
        }

        function updateLoginTexts(texts) {
            document.getElementById('loginTitle').textContent = `üìä ${texts.mainTitle}`;
            document.getElementById('loginSubtitle').textContent = texts.subtitle;
            document.getElementById('loginDepartment').textContent = texts.department;
            document.getElementById('loginDescription').textContent = `üîç ${texts.description}`;
        }

        function setupEventListeners() {
            // Manejar env√≠o del formulario de login
            loginForm.addEventListener('submit', handleLogin);
            
            // Permitir login con Enter
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !loginScreen.classList.contains('hidden')) {
                    handleLogin(e);
                }
            });

            // Botones de navegaci√≥n
            document.getElementById('adminLogout').addEventListener('click', logout);
            document.getElementById('backToLogin').addEventListener('click', logout);

            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Admin Panel Event Listeners
            setupAdminEventListeners();
            

        }

        function setupAdminEventListeners() {
            // Inicializar Firebase
            document.getElementById('initFirebaseBtn').addEventListener('click', initializeFirebaseData);

            // Guardar textos de login
            document.getElementById('saveLoginTexts').addEventListener('click', saveLoginTexts);

            // Gesti√≥n de usuarios
            document.getElementById('addUserBtn').addEventListener('click', () => openUserModal());
            document.getElementById('clearTableBtn').addEventListener('click', showConfirmModal);

            // Modales de usuario
            document.getElementById('closeUserModal').addEventListener('click', closeUserModal);
            document.getElementById('cancelUserModal').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', saveUser);

            // Modal de detalles
            document.getElementById('closeDetailsModal').addEventListener('click', closeDetailsModal);
            document.getElementById('cancelDetailsModal').addEventListener('click', closeDetailsModal);
            document.getElementById('userDetailsForm').addEventListener('submit', saveUserDetails);

            // Modal de confirmaci√≥n
            document.getElementById('confirmClear').addEventListener('click', clearAllUsers);
            document.getElementById('cancelClear').addEventListener('click', closeConfirmModal);

            // Modales de categor√≠as
            document.getElementById('editCategoriesBtn').addEventListener('click', openCategoriesModal);
            document.getElementById('closeCategoriesModal').addEventListener('click', closeCategoriesModal);
            document.getElementById('cancelCategoriesBtn').addEventListener('click', closeCategoriesModal);
            document.getElementById('addCategoryBtn').addEventListener('click', addCategoryRow);
            document.getElementById('saveCategoriesBtn').addEventListener('click', saveCategories);

            // CSV functionality
            document.getElementById('downloadCSVBtn').addEventListener('click', downloadCSVTemplate);
            document.getElementById('uploadCSVBtn').addEventListener('click', () => {
                document.getElementById('csvFileInput').click();
            });
            document.getElementById('csvFileInput').addEventListener('change', handleCSVUpload);
        }

        // ===== INICIALIZACI√ìN AUTOM√ÅTICA DE FIREBASE =====

        async function initializeFirebaseData() {
            try {
                showNotification('üîß Inicializando Firebase...', 'info');
                
                // Crear usuarios en Authentication
                await createDefaultUsers();
                
                // Crear configuraci√≥n en Firestore
                await createDefaultConfig();
                
                // Crear usuarios de ejemplo en Firestore
                await createDefaultUserData();
                
                isFirebaseInitialized = true;
                updateFirebaseStatus('üü¢ Inicializado Correctamente', 'text-green-600');
                showNotification('‚úÖ Firebase inicializado correctamente');
                
                // Recargar datos
                await loadConfiguration();
                loadUsersTable();
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                showNotification('‚ùå Error inicializando Firebase: ' + error.message, 'error');
            }
        }

        async function createDefaultUsers() {
            const { createUserWithEmailAndPassword } = window.firebaseFunctions;
            const auth = window.firebaseAuth;
            
            const usersToCreate = [
                { email: 'admin@cnci.edu.mx', password: 'admin123' },
                { email: 'usuario01@cnci.edu.mx', password: 'password123' },
                { email: 'usuario02@cnci.edu.mx', password: 'password123' }
            ];
            
            for (const user of usersToCreate) {
                try {
                    await createUserWithEmailAndPassword(auth, user.email, user.password);
                    console.log(`Usuario creado: ${user.email}`);
                } catch (error) {
                    if (error.code !== 'auth/email-already-in-use') {
                        console.error(`Error creando usuario ${user.email}:`, error);
                    }
                }
            }
        }

        async function createDefaultConfig() {
            const { setDoc, doc } = window.firebaseFunctions;
            
            // Guardar textos de login
            await setDoc(doc(window.firebaseDb, 'config', 'loginTexts'), defaultData.loginTexts);
            
            // Guardar template de evaluaci√≥n
            await setDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'), defaultData.evaluationTemplate);
            
            // Guardar credenciales de usuarios
            await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
        }

        async function createDefaultUserData() {
            const { setDoc, doc } = window.firebaseFunctions;
            
            for (const user of defaultData.defaultUsers) {
                await setDoc(doc(window.firebaseDb, 'users', user.username), user);
            }
        }

        // ===== FUNCIONES DE LOGIN =====

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                // Verificar credenciales localmente primero
                if (!userCredentials[username]) {
                    throw new Error('Usuario no encontrado');
                }
                
                if (userCredentials[username].password !== password) {
                    throw new Error('Contrase√±a incorrecta');
                }
                
                // Cargar datos del usuario
                if (username === 'admin') {
                    currentUser = {
                        username: 'admin',
                        name: 'Administrador CNCI',
                        role: 'admin'
                    };
                } else {
                    await loadUserFromStorage(username);
                }
                
                loginError.classList.add('hidden');
                
                if (currentUser.role === 'admin') {
                    showAdminPanel();
                } else {
                    showDashboard();
                }
                
            } catch (error) {
                console.error('Error en login:', error);
                loginError.textContent = `‚ùå ${error.message}`;
                loginError.classList.remove('hidden');
            }
        }

        async function loadUserFromStorage(username) {
            try {
                if (isFirebaseInitialized) {
                    // Intentar cargar desde Firestore
                    const { getDoc, doc } = window.firebaseFunctions;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', username));
                    if (userDoc.exists()) {
                        currentUser = userDoc.data();
                        return;
                    }
                }
                
                // Fallback a datos locales
                const userData = defaultData.defaultUsers.find(u => u.username === username);
                if (userData) {
                    currentUser = userData;
                } else {
                    throw new Error('Datos de usuario no encontrados');
                }
            } catch (error) {
                console.error('Error cargando usuario:', error);
                throw new Error('Error cargando datos del usuario');
            }
        }



        // ===== FUNCIONES DE NAVEGACI√ìN =====

        function showAdminPanel() {
            loginScreen.classList.add('hidden');
            dashboard.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            
            loadAdminData();
        }

        function showDashboard() {
            loginScreen.classList.add('hidden');
            adminPanel.classList.add('hidden');
            dashboard.classList.remove('hidden');
            
            loadUserData();
        }

        function logout() {
            if (isFirebaseInitialized) {
                const { signOut } = window.firebaseFunctions;
                signOut(window.firebaseAuth);
            }
            
            currentUser = null;
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            dashboard.classList.add('hidden');
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loginError.classList.add('hidden');
        }

        // ===== FUNCIONES DEL DASHBOARD =====

        function calculateGeneralScore(categories) {
            if (!categories || Object.keys(categories).length === 0) return 0;
            
            const scores = Object.values(categories).map(category => category.score || 0);
            const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            return Math.round(average * 10) / 10; // Redondear a 1 decimal
        }

        function calculateCategoryScore(criteria) {
            if (!criteria || criteria.length === 0) return 0;
            
            const scores = criteria.map(criterion => {
                if (typeof criterion === 'object' && criterion.score !== undefined) {
                    return criterion.score;
                }
                return 0;
            });
            
            const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            return Math.round(average * 10) / 10; // Redondear a 1 decimal
        }

        function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            // Calcular puntaje general como promedio de todas las categor√≠as
            const generalScore = calculateGeneralScore(currentUser.categories);
            document.getElementById('generalScore').textContent = generalScore + '/10';
            document.getElementById('generalComments').textContent = currentUser.generalComments;
            
            loadEvaluationCategories();
            loadUserBadges();
            loadUserWorkPlan();
        }

        function loadEvaluationCategories() {
            const container = document.getElementById('evaluationCategories');
            container.innerHTML = '';
            
            if (!currentUser.categories) return;
            
            Object.entries(currentUser.categories).forEach(([categoryName, categoryData]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white border border-gray-200 rounded-xl p-6 card-shadow slide-in';
                
                // Crear lista de criterios con calificaciones individuales
                const criteriaList = categoryData.criteria.map(criteria => {
                    if (typeof criteria === 'object' && criteria.name && criteria.score !== undefined) {
                        return `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded-lg mb-2">
                            <span class="text-gray-700 text-sm">${criteria.name}</span>
                            <span class="font-semibold text-[#2a6aff] text-sm">${criteria.score}/10</span>
                        </div>`;
                    } else {
                        // Compatibilidad con formato anterior
                        return `<span class="inline-block bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm mr-2 mb-2">${criteria}</span>`;
                    }
                }).join('');
                
                // Calcular porcentaje para la barra de progreso (score/10 * 100)
                const progressPercentage = (categoryData.score / 10) * 100;
                
                categoryCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="text-lg font-semibold text-gray-800">${categoryName}</h4>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-[#2a6aff]">${categoryData.score}</div>
                            <div class="text-sm text-gray-500">/10</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="bg-gray-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-[#2a6aff] to-[#ff8500] h-3 rounded-full transition-all duration-500" 
                                 style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 text-center">${progressPercentage.toFixed(1)}%</div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600 font-medium">Criterios evaluados:</p>
                        <div class="space-y-1">${criteriaList}</div>
                    </div>
                `;
                
                container.appendChild(categoryCard);
            });
        }

        function loadUserBadges() {
            const badgesContainer = document.getElementById('userBadges');
            badgesContainer.innerHTML = '';
            
            if (!currentUser.badges) return;
            
            const badges = [
                { key: 'excellence', name: 'Excelencia', emoji: 'ü•á', description: 'Calificaci√≥n superior a 90', bgColor: 'bg-yellow-50', borderColor: 'border-yellow-200', textColor: 'text-yellow-800' },
                { key: 'communicator', name: 'Comunicador', emoji: 'üìû', description: 'Excelente en llamadas', bgColor: 'bg-blue-50', borderColor: 'border-blue-200', textColor: 'text-blue-800' },
                { key: 'consistent', name: 'Consistente', emoji: '‚≠ê', description: 'Desempe√±o estable', bgColor: 'bg-green-50', borderColor: 'border-green-200', textColor: 'text-green-800' }
            ];
            
            badges.forEach(badge => {
                if (currentUser.badges[badge.key]) {
                    const badgeElement = document.createElement('div');
                    badgeElement.className = `${badge.bgColor} border-2 ${badge.borderColor} p-6 rounded-xl text-center transform hover:scale-105 transition-all`;
                    badgeElement.innerHTML = `
                        <div class="text-4xl mb-3">${badge.emoji}</div>
                        <h4 class="font-semibold ${badge.textColor}">${badge.name}</h4>
                        <p class="text-sm ${badge.textColor.replace('800', '600')} mt-2">${badge.description}</p>
                        <div class="mt-3 text-xs ${badge.textColor} font-medium">‚úÖ OBTENIDA</div>
                    `;
                    badgesContainer.appendChild(badgeElement);
                }
            });
            
            if (badgesContainer.children.length === 0) {
                badgesContainer.innerHTML = `
                    <div class="col-span-3 text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">üéØ</div>
                        <p>¬°Sigue trabajando para obtener tus primeras insignias!</p>
                    </div>
                `;
            }
        }

        function loadUserWorkPlan() {
            const objectivesDisplay = document.getElementById('userObjectivesDisplay');
            const resourcesDisplay = document.getElementById('userResourcesDisplay');
            const notesDisplay = document.getElementById('userAdditionalNotesDisplay');
            const notesSection = document.getElementById('additionalNotesSection');
            
            if (currentUser.workPlan) {
                objectivesDisplay.textContent = currentUser.workPlan.objectives || 'No hay objetivos espec√≠ficos definidos a√∫n.';
                resourcesDisplay.textContent = currentUser.workPlan.resources || 'No hay recursos recomendados espec√≠ficos a√∫n.';
                
                if (currentUser.workPlan.additionalNotes && currentUser.workPlan.additionalNotes.trim()) {
                    notesDisplay.textContent = currentUser.workPlan.additionalNotes;
                    notesSection.classList.remove('hidden');
                } else {
                    notesSection.classList.add('hidden');
                }
            } else {
                objectivesDisplay.textContent = 'Plan de trabajo personalizado en desarrollo...';
                resourcesDisplay.textContent = 'Recursos ser√°n asignados seg√∫n tu desempe√±o...';
                notesSection.classList.add('hidden');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
                button.classList.add('text-gray-600');
            });
            
            document.getElementById(tabName).classList.remove('hidden');
            
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            activeButton.classList.add('tab-active');
            activeButton.classList.remove('text-gray-600');
        }

        // ===== FUNCIONES DEL PANEL DE ADMINISTRADOR =====

        async function loadAdminData() {
            await loadUsersTable();
            loadLoginTextsToForm();
        }

        function loadLoginTextsToForm() {
            if (isFirebaseInitialized) {
                // Los datos ya se cargaron en loadConfiguration
                const loginTexts = {
                    mainTitle: document.getElementById('loginTitle').textContent.replace('üìä ', ''),
                    subtitle: document.getElementById('loginSubtitle').textContent,
                    department: document.getElementById('loginDepartment').textContent,
                    description: document.getElementById('loginDescription').textContent.replace('üîç ', '')
                };
                
                document.getElementById('mainTitle').value = loginTexts.mainTitle;
                document.getElementById('subtitle').value = loginTexts.subtitle;
                document.getElementById('department').value = loginTexts.department;
                document.getElementById('description').value = loginTexts.description;
            } else {
                // Usar datos por defecto
                document.getElementById('mainTitle').value = defaultData.loginTexts.mainTitle;
                document.getElementById('subtitle').value = defaultData.loginTexts.subtitle;
                document.getElementById('department').value = defaultData.loginTexts.department;
                document.getElementById('description').value = defaultData.loginTexts.description;
            }
        }

        async function saveLoginTexts() {
            const loginTexts = {
                mainTitle: document.getElementById('mainTitle').value,
                subtitle: document.getElementById('subtitle').value,
                department: document.getElementById('department').value,
                description: document.getElementById('description').value
            };

            try {
                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    await setDoc(doc(window.firebaseDb, 'config', 'loginTexts'), loginTexts);
                }
                
                // Actualizar la interfaz inmediatamente
                updateLoginTexts(loginTexts);
                showNotification('‚úÖ Textos de login actualizados correctamente');
            } catch (error) {
                console.error('Error guardando textos:', error);
                showNotification('‚ùå Error al guardar los textos', 'error');
            }
        }

        async function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            try {
                if (isFirebaseInitialized) {
                    // Cargar desde Firestore
                    const { getDocs, collection, query, where } = window.firebaseFunctions;
                    const usersQuery = query(collection(window.firebaseDb, 'users'), where('role', '==', 'user'));
                    const querySnapshot = await getDocs(usersQuery);
                    
                    allUsers = [];
                    querySnapshot.forEach((doc) => {
                        allUsers.push(doc.data());
                    });
                } else {
                    // Usar datos por defecto
                    allUsers = [...defaultData.defaultUsers];
                }

                allUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    
                    const shortComments = user.generalComments ? 
                        (user.generalComments.length > 50 ? user.generalComments.substring(0, 50) + '...' : user.generalComments) : 
                        'Sin comentarios';

                    // Obtener la contrase√±a actual del usuario
                    const currentPassword = userCredentials[user.username]?.password || user.password || 'password123';

                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${user.username || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${user.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <span class="bg-gray-100 px-2 py-1 rounded font-mono text-xs">${currentPassword}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${calculateGeneralScore(user.categories)}/10</td>
                        <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">${shortComments}</td>
                        <td class="px-4 py-3 text-sm space-x-2">
                            <button onclick="editUser('${user.username}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-all">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="showUserDetails('${user.username}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition-all">
                                üìä Detalles
                            </button>
                            <button onclick="deleteUser('${user.username}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-all">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showNotification('‚ùå Error cargando usuarios', 'error');
            }
        }

        // ===== GESTI√ìN DE USUARIOS =====

        function openUserModal(username = null) {
            currentEditingUser = username;
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            
            if (username) {
                title.textContent = '‚úèÔ∏è Editar Usuario';
                const user = allUsers.find(u => u.username === username);
                if (user) {
                    document.getElementById('userId').value = user.username || '';
                    document.getElementById('userNameInput').value = user.name || '';
                    document.getElementById('userGeneralScore').value = user.generalScore || 0;
                    document.getElementById('userComments').value = user.generalComments || '';
                    // Mostrar contrase√±a actual como placeholder
                    const currentPassword = userCredentials[username]?.password || user.password || 'password123';
                    document.getElementById('userPassword').placeholder = `Actual: ${currentPassword}`;
                }
            } else {
                title.textContent = '‚ûï A√±adir Usuario';
                document.getElementById('userForm').reset();
                document.getElementById('userPassword').placeholder = 'Contrase√±a para el nuevo usuario';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeUserModal() {
            const modal = document.getElementById('userModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditingUser = null;
        }

        async function saveUser(e) {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('userId').value,
                name: document.getElementById('userNameInput').value,
                role: 'user',
                generalComments: document.getElementById('userComments').value,
                categories: getDefaultCategories(),
                badges: {
                    excellence: false,
                    communicator: false,
                    consistent: false
                },
                workPlan: {
                    objectives: '',
                    resources: '',
                    additionalNotes: ''
                }
            };

            const newPassword = document.getElementById('userPassword').value;

            try {
                // Actualizar contrase√±a en el sistema local
                if (newPassword && newPassword.trim() !== '') {
                    userCredentials[userData.username] = {
                        password: newPassword,
                        role: 'user'
                    };
                    userData.password = newPassword;
                } else if (!userCredentials[userData.username]) {
                    // Usuario nuevo sin contrase√±a especificada
                    userCredentials[userData.username] = {
                        password: 'password123',
                        role: 'user'
                    };
                    userData.password = 'password123';
                } else {
                    // Mantener contrase√±a existente
                    userData.password = userCredentials[userData.username].password;
                }

                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    
                    // Si es un usuario existente, preservar datos adicionales
                    if (currentEditingUser) {
                        const existingUser = allUsers.find(u => u.username === currentEditingUser);
                        if (existingUser) {
                            userData.badges = existingUser.badges || userData.badges;
                            userData.workPlan = existingUser.workPlan || userData.workPlan;
                            userData.categories = existingUser.categories || userData.categories;
                        }
                    }
                    
                    await setDoc(doc(window.firebaseDb, 'users', userData.username), userData);
                    
                    // Guardar credenciales en Firebase
                    await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
                    
                    // Sincronizar categor√≠as con el template actual
                    await updateUserCategoriesFromTemplate(userData.username);
                } else {
                    // Modo local
                    if (currentEditingUser) {
                        const existingUserIndex = allUsers.findIndex(u => u.username === currentEditingUser);
                        if (existingUserIndex !== -1) {
                            // Preservar datos adicionales en modo local
                            userData.badges = allUsers[existingUserIndex].badges || userData.badges;
                            userData.workPlan = allUsers[existingUserIndex].workPlan || userData.workPlan;
                            userData.categories = syncUserCategories(allUsers[existingUserIndex].categories || {}, categoriesData);
                            allUsers[existingUserIndex] = userData;
                        }
                    } else {
                        userData.categories = syncUserCategories({}, categoriesData);
                        allUsers.push(userData);
                    }
                }
                
                closeUserModal();
                await loadUsersTable();
                showNotification('‚úÖ Usuario y contrase√±a guardados correctamente');
            } catch (error) {
                console.error('Error guardando usuario:', error);
                showNotification('‚ùå Error al guardar el usuario', 'error');
            }
        }

        function getDefaultCategories() {
            const categories = {};
            categoriesData.forEach(category => {
                categories[category.name] = {
                    score: 0,
                    criteria: [...category.criteria]
                };
            });
            return categories;
        }

        // Funci√≥n para actualizar categor√≠as cuando se crea un nuevo usuario
        async function updateUserCategoriesFromTemplate(username) {
            if (!isFirebaseInitialized) return;
            
            try {
                const { getDoc, doc, updateDoc } = window.firebaseFunctions;
                
                // Obtener el template actual
                const templateDoc = await getDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'));
                if (!templateDoc.exists()) return;
                
                const currentTemplate = templateDoc.data();
                const userDoc = await getDoc(doc(window.firebaseDb, 'users', username));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const syncedCategories = syncUserCategories(userData.categories || {}, currentTemplate.categories);
                    
                    await updateDoc(doc(window.firebaseDb, 'users', username), {
                        categories: syncedCategories
                    });
                }
            } catch (error) {
                console.error('Error actualizando categor√≠as del usuario:', error);
            }
        }

        function editUser(username) {
            openUserModal(username);
        }

        async function deleteUser(username) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este usuario?')) {
                try {
                    if (isFirebaseInitialized) {
                        const { deleteDoc, doc } = window.firebaseFunctions;
                        await deleteDoc(doc(window.firebaseDb, 'users', username));
                    }
                    
                    await loadUsersTable();
                    showNotification('‚úÖ Usuario eliminado correctamente');
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    showNotification('‚ùå Error al eliminar el usuario', 'error');
                }
            }
        }

        // ===== MODAL DE DETALLES =====

        function updateCategoryScore(categoryName) {
            // Obtener todas las calificaciones de criterios para esta categor√≠a
            const criteriaScores = document.querySelectorAll(`[data-category="${categoryName}"].criteria-score`);
            const scores = Array.from(criteriaScores).map(input => parseFloat(input.value) || 0);
            
            // Calcular promedio
            const average = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
            const roundedAverage = Math.round(average * 10) / 10;
            
            // Actualizar display del puntaje de categor√≠a
            const scoreDisplay = document.querySelector(`[data-category="${categoryName}"].category-score-display`);
            if (scoreDisplay) {
                scoreDisplay.textContent = roundedAverage;
            }
            
            // Actualizar puntaje general
            updateGeneralScore();
        }

        function updateGeneralScore() {
            const categoryScores = document.querySelectorAll('.category-score-display');
            const scores = Array.from(categoryScores).map(display => parseFloat(display.textContent) || 0);
            
            if (scores.length > 0) {
                const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                const roundedAverage = Math.round(average * 10) / 10;
                
                const generalScoreInput = document.getElementById('detailsGeneralScore');
                if (generalScoreInput) {
                    generalScoreInput.value = roundedAverage + '/10';
                }
            }
        }

        function showUserDetails(username) {
            const user = allUsers.find(u => u.username === username);
            if (!user) return;

            document.getElementById('detailsUserId').value = user.username || '';
            document.getElementById('detailsUserName').value = user.name || '';
            document.getElementById('detailsUserRole').value = user.role || 'user';
            document.getElementById('detailsGeneralScore').value = calculateGeneralScore(user.categories) + '/10';
            document.getElementById('detailsGeneralComments').value = user.generalComments || '';
            document.getElementById('detailsUserPassword').value = ''; // Siempre vac√≠o por seguridad

            // Cargar insignias
            document.getElementById('badgeExcellence').checked = user.badges?.excellence || false;
            document.getElementById('badgeCommunicator').checked = user.badges?.communicator || false;
            document.getElementById('badgeConsistent').checked = user.badges?.consistent || false;

            // Cargar plan de trabajo
            document.getElementById('userObjectives').value = user.workPlan?.objectives || '';
            document.getElementById('userResources').value = user.workPlan?.resources || '';
            document.getElementById('userAdditionalNotes').value = user.workPlan?.additionalNotes || '';

            loadUserCategories(user);

            currentEditingUser = username;
            const modal = document.getElementById('userDetailsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function loadUserCategories(user) {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            if (user.categories) {
                Object.entries(user.categories).forEach(([categoryName, categoryData]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-gray-50 p-4 rounded-lg';
                    
                    // Crear inputs para criterios con calificaciones individuales
                    const criteriaInputs = categoryData.criteria.map((criteria, index) => {
                        let criteriaName = '';
                        let criteriaScore = 0;
                        
                        if (typeof criteria === 'object' && criteria.name && criteria.score !== undefined) {
                            criteriaName = criteria.name;
                            criteriaScore = criteria.score;
                        } else {
                            // Compatibilidad con formato anterior
                            criteriaName = criteria;
                            criteriaScore = 0;
                        }
                        
                        return `
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="text" value="${criteriaName}" 
                                       class="criteria-name flex-1 px-3 py-1 border border-gray-300 rounded text-sm" 
                                       data-category="${categoryName}" data-index="${index}">
                                <input type="number" value="${criteriaScore}" min="0" max="10" step="0.1"
                                       class="criteria-score w-20 px-2 py-1 border border-gray-300 rounded text-sm text-center" 
                                       data-category="${categoryName}" data-index="${index}"
                                       onchange="updateCategoryScore('${categoryName}')">
                                <span class="text-xs text-gray-500">/10</span>
                            </div>
                        `;
                    }).join('');

                    categoryDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-gray-800">${categoryName}</h5>
                            <div class="text-right">
                                <span class="category-score-display text-lg font-bold text-[#2a6aff]" data-category="${categoryName}">${categoryData.score}</span>
                                <span class="text-sm text-gray-500">/10</span>
                                <div class="text-xs text-gray-400">(Promedio autom√°tico)</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Criterios y Calificaciones:</label>
                            ${criteriaInputs}
                        </div>
                    `;
                    
                    container.appendChild(categoryDiv);
                });
            }
        }

        function closeDetailsModal() {
            const modal = document.getElementById('userDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditingUser = null;
        }

        async function saveUserDetails(e) {
            e.preventDefault();
            
            if (!currentEditingUser) return;

            const userData = {
                username: document.getElementById('detailsUserId').value,
                name: document.getElementById('detailsUserName').value,
                role: document.getElementById('detailsUserRole').value,
                generalComments: document.getElementById('detailsGeneralComments').value,
                categories: {},
                badges: {
                    excellence: document.getElementById('badgeExcellence').checked,
                    communicator: document.getElementById('badgeCommunicator').checked,
                    consistent: document.getElementById('badgeConsistent').checked
                },
                workPlan: {
                    objectives: document.getElementById('userObjectives').value,
                    resources: document.getElementById('userResources').value,
                    additionalNotes: document.getElementById('userAdditionalNotes').value
                }
            };

            const newPassword = document.getElementById('detailsUserPassword').value;

            // Actualizar contrase√±a si se proporcion√≥ una nueva
            if (newPassword && newPassword.trim() !== '') {
                userCredentials[currentEditingUser] = {
                    password: newPassword,
                    role: userData.role
                };
                userData.password = newPassword;
            } else {
                // Mantener contrase√±a existente
                userData.password = userCredentials[currentEditingUser]?.password || 'password123';
            }

            // Recopilar datos de categor√≠as con criterios y calificaciones
            const categoryNames = [...new Set(Array.from(document.querySelectorAll('[data-category]')).map(el => el.dataset.category))];
            
            categoryNames.forEach(categoryName => {
                const criteriaNames = document.querySelectorAll(`[data-category="${categoryName}"].criteria-name`);
                const criteriaScores = document.querySelectorAll(`[data-category="${categoryName}"].criteria-score`);
                
                const criteria = Array.from(criteriaNames).map((nameInput, index) => ({
                    name: nameInput.value,
                    score: parseFloat(criteriaScores[index]?.value) || 0
                }));
                
                // Calcular el puntaje de la categor√≠a como promedio de criterios
                const categoryScore = calculateCategoryScore(criteria);
                
                userData.categories[categoryName] = { 
                    score: categoryScore, 
                    criteria: criteria 
                };
            });

            try {
                if (isFirebaseInitialized) {
                    const { setDoc, doc } = window.firebaseFunctions;
                    await setDoc(doc(window.firebaseDb, 'users', currentEditingUser), userData);
                    
                    // Guardar credenciales actualizadas en Firebase
                    await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
                } else {
                    // Actualizar en modo local
                    const userIndex = allUsers.findIndex(u => u.username === currentEditingUser);
                    if (userIndex !== -1) {
                        allUsers[userIndex] = userData;
                    }
                }
                
                closeDetailsModal();
                await loadUsersTable();
                showNotification('‚úÖ Usuario y contrase√±a actualizados correctamente');
            } catch (error) {
                console.error('Error actualizando usuario:', error);
                showNotification('‚ùå Error al actualizar el usuario', 'error');
            }
        }

        // ===== VACIAR TABLA =====

        function showConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function clearAllUsers() {
            try {
                if (isFirebaseInitialized) {
                    const { deleteDoc, doc } = window.firebaseFunctions;
                    for (const user of allUsers) {
                        await deleteDoc(doc(window.firebaseDb, 'users', user.username));
                    }
                }
                
                closeConfirmModal();
                await loadUsersTable();
                showNotification('‚úÖ Todos los usuarios han sido eliminados');
            } catch (error) {
                console.error('Error vaciando tabla:', error);
                showNotification('‚ùå Error al vaciar la tabla', 'error');
            }
        }

        // ===== GESTI√ìN DE CATEGOR√çAS =====

        function openCategoriesModal() {
            loadCategoriesEditContainer();
            const modal = document.getElementById('categoriesModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeCategoriesModal() {
            const modal = document.getElementById('categoriesModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function loadCategoriesEditContainer() {
            const container = document.getElementById('categoriesEditContainer');
            container.innerHTML = '';

            categoriesData.forEach((category, index) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-gray-50 p-4 rounded-lg';
                
                const criteriaInputs = category.criteria.map((criteria, criteriaIndex) => 
                    `<div class="flex items-center space-x-2 mb-2">
                        <input type="text" value="${criteria}" class="flex-1 px-3 py-1 border border-gray-300 rounded text-sm" data-category="${index}" data-criteria="${criteriaIndex}">
                        <button type="button" onclick="removeCriteria(${index}, ${criteriaIndex})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                            üóëÔ∏è
                        </button>
                    </div>`
                ).join('');

                categoryDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <input type="text" value="${category.name}" class="font-semibold text-lg border-b-2 border-transparent hover:border-gray-300 focus:border-[#2a6aff] outline-none" data-category-name="${index}">
                        <button type="button" onclick="removeCategory(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            üóëÔ∏è Eliminar Categor√≠a
                        </button>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Criterios:</label>
                        ${criteriaInputs}
                        <button type="button" onclick="addCriteria(${index})" class="bg-[#ff8500] hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                            ‚ûï A√±adir Criterio
                        </button>
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }

        function addCategoryRow() {
            categoriesData.push({
                name: 'Nueva Categor√≠a',
                criteria: ['Nuevo Criterio']
            });
            loadCategoriesEditContainer();
        }

        function removeCategory(index) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar esta categor√≠a?')) {
                categoriesData.splice(index, 1);
                loadCategoriesEditContainer();
            }
        }

        function addCriteria(categoryIndex) {
            categoriesData[categoryIndex].criteria.push('Nuevo Criterio');
            loadCategoriesEditContainer();
        }

        function removeCriteria(categoryIndex, criteriaIndex) {
            if (categoriesData[categoryIndex].criteria.length > 1) {
                categoriesData[categoryIndex].criteria.splice(criteriaIndex, 1);
                loadCategoriesEditContainer();
            } else {
                alert('Una categor√≠a debe tener al menos un criterio');
            }
        }

        async function saveCategories() {
            const updatedCategories = [];
            
            document.querySelectorAll('[data-category-name]').forEach((input, index) => {
                const categoryName = input.value;
                const criteria = [];
                
                document.querySelectorAll(`[data-category="${index}"][data-criteria]`).forEach(criteriaInput => {
                    criteria.push(criteriaInput.value);
                });
                
                updatedCategories.push({ name: categoryName, criteria });
            });

            try {
                showNotification('üîÑ Actualizando categor√≠as y sincronizando usuarios...', 'info');
                
                if (isFirebaseInitialized) {
                    const { setDoc, doc, getDocs, collection, query, where, updateDoc } = window.firebaseFunctions;
                    
                    // 1. Guardar el nuevo template de categor√≠as
                    await setDoc(doc(window.firebaseDb, 'config', 'evaluationTemplate'), {
                        categories: updatedCategories
                    });
                    
                    // 2. Obtener todos los usuarios existentes
                    const usersQuery = query(collection(window.firebaseDb, 'users'), where('role', '==', 'user'));
                    const querySnapshot = await getDocs(usersQuery);
                    
                    // 3. Actualizar cada usuario con las nuevas categor√≠as
                    const updatePromises = [];
                    querySnapshot.forEach((userDoc) => {
                        const userData = userDoc.data();
                        const updatedUserCategories = syncUserCategories(userData.categories || {}, updatedCategories);
                        
                        updatePromises.push(
                            updateDoc(doc(window.firebaseDb, 'users', userData.username), {
                                categories: updatedUserCategories
                            })
                        );
                    });
                    
                    // Ejecutar todas las actualizaciones en paralelo
                    await Promise.all(updatePromises);
                    
                    showNotification(`‚úÖ Categor√≠as actualizadas y sincronizadas con ${updatePromises.length} usuarios`);
                } else {
                    // Modo local - actualizar usuarios en memoria
                    allUsers.forEach(user => {
                        user.categories = syncUserCategories(user.categories || {}, updatedCategories);
                    });
                    
                    showNotification('‚úÖ Categor√≠as actualizadas localmente');
                }
                
                categoriesData = [...updatedCategories];
                evaluationTemplate = { categories: updatedCategories };
                
                closeCategoriesModal();
                await loadUsersTable(); // Recargar la tabla para mostrar cambios
                
            } catch (error) {
                console.error('Error guardando categor√≠as:', error);
                showNotification('‚ùå Error al guardar las categor√≠as', 'error');
            }
        }

        // Funci√≥n para sincronizar categor√≠as de usuario con el template actualizado
        function syncUserCategories(userCategories, newCategoriesTemplate) {
            const syncedCategories = {};
            
            newCategoriesTemplate.forEach(templateCategory => {
                const existingCategory = userCategories[templateCategory.name];
                
                if (existingCategory) {
                    // La categor√≠a existe - mantener el puntaje pero actualizar criterios
                    syncedCategories[templateCategory.name] = {
                        score: existingCategory.score || 0,
                        criteria: [...templateCategory.criteria] // Usar los nuevos criterios del template
                    };
                } else {
                    // Nueva categor√≠a - crear con puntaje 0
                    syncedCategories[templateCategory.name] = {
                        score: 0,
                        criteria: [...templateCategory.criteria]
                    };
                }
            });
            
            return syncedCategories;
        }

        // ===== FUNCIONES CSV =====

        function downloadCSVTemplate() {
            try {
                showNotification('üì• Generando plantilla CSV...', 'info');
                
                // Crear headers del CSV
                const headers = [
                    'username',
                    'name', 
                    'password',
                    'role',
                    'generalComments',
                    'badgeExcellence',
                    'badgeCommunicator', 
                    'badgeConsistent',
                    'workPlanObjectives',
                    'workPlanResources',
                    'workPlanAdditionalNotes'
                ];

                // A√±adir headers para cada categor√≠a y sus criterios
                categoriesData.forEach(category => {
                    headers.push(`category_${category.name}_score`);
                    category.criteria.forEach((criteria, index) => {
                        headers.push(`category_${category.name}_criteria_${index + 1}_name`);
                        headers.push(`category_${category.name}_criteria_${index + 1}_score`);
                    });
                });

                // Crear filas de datos
                const rows = [headers];
                
                allUsers.forEach(user => {
                    const row = [
                        user.username || '',
                        user.name || '',
                        userCredentials[user.username]?.password || user.password || 'password123',
                        user.role || 'user',
                        user.generalComments || '',
                        user.badges?.excellence ? 'true' : 'false',
                        user.badges?.communicator ? 'true' : 'false',
                        user.badges?.consistent ? 'true' : 'false',
                        user.workPlan?.objectives || '',
                        user.workPlan?.resources || '',
                        user.workPlan?.additionalNotes || ''
                    ];

                    // A√±adir datos de categor√≠as
                    categoriesData.forEach(category => {
                        const userCategory = user.categories?.[category.name];
                        row.push(userCategory?.score || 0);
                        
                        category.criteria.forEach((templateCriteria, index) => {
                            const userCriteria = userCategory?.criteria?.[index];
                            if (typeof userCriteria === 'object' && userCriteria.name && userCriteria.score !== undefined) {
                                row.push(userCriteria.name);
                                row.push(userCriteria.score);
                            } else {
                                // Compatibilidad con formato anterior
                                row.push(templateCriteria);
                                row.push(0);
                            }
                        });
                    });

                    rows.push(row);
                });

                // Convertir a CSV con codificaci√≥n UTF-8
                const csvContent = rows.map(row => 
                    row.map(field => {
                        // Escapar comillas y envolver en comillas si contiene comas, saltos de l√≠nea o comillas
                        const stringField = String(field);
                        if (stringField.includes(',') || stringField.includes('\n') || stringField.includes('"')) {
                            return '"' + stringField.replace(/"/g, '""') + '"';
                        }
                        return stringField;
                    }).join(',')
                ).join('\n');

                // A√±adir BOM para UTF-8 para mejor compatibilidad con Excel
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;

                // Descargar archivo
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `plantilla_evaluacion_cnci_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ Plantilla CSV descargada correctamente');
                
            } catch (error) {
                console.error('Error generando CSV:', error);
                showNotification('‚ùå Error al generar la plantilla CSV', 'error');
            }
        }

        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('‚ùå Por favor selecciona un archivo CSV v√°lido', 'error');
                return;
            }

            try {
                showNotification('üì§ Procesando archivo CSV...', 'info');
                
                const text = await readFileAsText(file);
                const rows = parseCSV(text);
                
                if (rows.length < 2) {
                    showNotification('‚ùå El archivo CSV debe contener al menos una fila de datos', 'error');
                    return;
                }

                const headers = rows[0];
                const dataRows = rows.slice(1);
                
                // Validar headers b√°sicos
                const requiredHeaders = ['username', 'name', 'password'];
                const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
                
                if (missingHeaders.length > 0) {
                    showNotification(`‚ùå Faltan columnas requeridas: ${missingHeaders.join(', ')}`, 'error');
                    return;
                }

                let processedUsers = 0;
                let errors = [];

                for (const row of dataRows) {
                    try {
                        if (row.length !== headers.length) {
                            errors.push(`Fila con n√∫mero incorrecto de columnas: ${row.join(',').substring(0, 50)}...`);
                            continue;
                        }

                        const userData = {};
                        headers.forEach((header, index) => {
                            userData[header] = row[index];
                        });

                        // Validar datos b√°sicos
                        if (!userData.username || !userData.name) {
                            errors.push(`Usuario sin nombre o username: ${userData.username || 'N/A'}`);
                            continue;
                        }

                        // Procesar usuario
                        await processUserFromCSV(userData, headers);
                        processedUsers++;
                        
                    } catch (error) {
                        errors.push(`Error procesando usuario ${row[0] || 'desconocido'}: ${error.message}`);
                    }
                }

                // Recargar tabla y mostrar resultados
                await loadUsersTable();
                
                if (errors.length > 0) {
                    console.warn('Errores durante la carga:', errors);
                    showNotification(`‚ö†Ô∏è ${processedUsers} usuarios procesados. ${errors.length} errores encontrados (ver consola)`, 'info');
                } else {
                    showNotification(`‚úÖ ${processedUsers} usuarios cargados correctamente desde CSV`);
                }

            } catch (error) {
                console.error('Error procesando CSV:', error);
                showNotification('‚ùå Error al procesar el archivo CSV', 'error');
            } finally {
                // Limpiar input file
                event.target.value = '';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Error leyendo archivo'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // Comilla escapada
                            current += '"';
                            i++; // Saltar la siguiente comilla
                        } else {
                            // Cambiar estado de comillas
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // Separador de campo
                        row.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // A√±adir √∫ltimo campo
                row.push(current);
                rows.push(row);
            }
            
            return rows;
        }

        async function processUserFromCSV(userData, headers) {
            const user = {
                username: userData.username.trim(),
                name: userData.name.trim(),
                role: userData.role || 'user',
                password: userData.password || 'password123',
                generalComments: userData.generalComments || '',
                badges: {
                    excellence: userData.badgeExcellence === 'true',
                    communicator: userData.badgeCommunicator === 'true',
                    consistent: userData.badgeConsistent === 'true'
                },
                workPlan: {
                    objectives: userData.workPlanObjectives || '',
                    resources: userData.workPlanResources || '',
                    additionalNotes: userData.workPlanAdditionalNotes || ''
                },
                categories: {}
            };

            // Procesar categor√≠as desde CSV
            categoriesData.forEach(category => {
                const categoryScoreKey = `category_${category.name}_score`;
                const categoryScore = parseFloat(userData[categoryScoreKey]) || 0;
                
                const criteria = [];
                category.criteria.forEach((templateCriteria, index) => {
                    const criteriaNameKey = `category_${category.name}_criteria_${index + 1}_name`;
                    const criteriaScoreKey = `category_${category.name}_criteria_${index + 1}_score`;
                    
                    criteria.push({
                        name: userData[criteriaNameKey] || templateCriteria,
                        score: parseFloat(userData[criteriaScoreKey]) || 0
                    });
                });

                user.categories[category.name] = {
                    score: categoryScore,
                    criteria: criteria
                };
            });

            // Actualizar credenciales
            userCredentials[user.username] = {
                password: user.password,
                role: user.role
            };

            // Guardar usuario
            if (isFirebaseInitialized) {
                const { setDoc, doc } = window.firebaseFunctions;
                await setDoc(doc(window.firebaseDb, 'users', user.username), user);
                await setDoc(doc(window.firebaseDb, 'config', 'userCredentials'), userCredentials);
            } else {
                // Modo local
                const existingUserIndex = allUsers.findIndex(u => u.username === user.username);
                if (existingUserIndex !== -1) {
                    allUsers[existingUserIndex] = user;
                } else {
                    allUsers.push(user);
                }
            }
        }

        // ===== GENERACI√ìN DE REPORTE =====

        async function generateAndDownloadReport() {
            try {
                showNotification('üìÑ Generando reporte...', 'info');
                
                const currentScreen = getCurrentVisibleScreen();
                await ensureDataLoaded();
                showLoginScreen();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const htmlContent = document.documentElement.outerHTML;
                restoreScreen(currentScreen);
                downloadHTMLFile(htmlContent, 'reporte_evaluacion_cnci.html');
                
                showNotification('‚úÖ Reporte descargado correctamente');
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                showNotification('‚ùå Error al generar el reporte', 'error');
            }
        }

        function getCurrentVisibleScreen() {
            if (!loginScreen.classList.contains('hidden')) return 'login';
            if (!adminPanel.classList.contains('hidden')) return 'admin';
            if (!dashboard.classList.contains('hidden')) return 'dashboard';
            return 'login';
        }

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            dashboard.classList.add('hidden');
            loadingScreen.classList.add('hidden');
        }

        function restoreScreen(screenType) {
            switch (screenType) {
                case 'admin':
                    showAdminPanel();
                    break;
                case 'dashboard':
                    showDashboard();
                    break;
                default:
                    showLoginScreen();
                    break;
            }
        }

        async function ensureDataLoaded() {
            await new Promise(resolve => setTimeout(resolve, 50));
        }

        function downloadHTMLFile(htmlContent, filename) {
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = filename;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(downloadLink.href);
        }

        // ===== UTILIDADES =====

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium transition-all transform translate-x-full`;
            
            if (type === 'success') {
                notification.className += ' bg-green-500';
            } else if (type === 'error') {
                notification.className += ' bg-red-500';
            } else if (type === 'info') {
                notification.className += ' bg-blue-500';
            } else {
                notification.className += ' bg-gray-500';
            }
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Hacer funciones globales para los botones inline
        window.editUser = editUser;
        window.showUserDetails = showUserDetails;
        window.deleteUser = deleteUser;
        window.removeCategory = removeCategory;
        window.addCriteria = addCriteria;
        window.removeCriteria = removeCriteria;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9798d604a76620aa',t:'MTc1Njk0MDE0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
